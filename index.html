<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Magic Automation Lab</title>
  <script>
    // Check for existing connection synchronously before page renders
    (function() {
      try {
        const oauthTokens = localStorage.getItem('@deriv_oauth_tokens');
        const apiKey = localStorage.getItem('@deriv_api_key');
        if (oauthTokens || apiKey) {
          document.documentElement.setAttribute('data-has-connection', 'true');
        }
      } catch (e) {
        // Ignore localStorage errors
      }
    })();
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: dark;
      --bg: #0f1117;
      --panel: #171b24;
      --panel-strong: #1f2531;
      --accent: #00d2ff;
      --accent-2: #ff7a18;
      --text: #f5f7ff;
      --muted: #98a2bd;
      --border: rgba(255,255,255,0.08);
      --success: #24d970;
      --danger: #ff5f6d;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top right, rgba(0, 210, 255, 0.25), transparent 40%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .grid-bg {
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size: 48px 48px;
      z-index: 0;
    }

    .page {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 32px 24px 100px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      flex: 1;
      box-sizing: border-box;
    }

    @media (max-width: 768px) {
      .page {
        padding: 20px 16px 90px;
        gap: 16px;
      }
    }

    @media (max-width: 480px) {
      .page {
        padding: 16px 12px 85px;
        gap: 12px;
      }
    }

    .card-wrapper {
      flex: 1;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: auto;
      box-sizing: border-box;
    }

    .card {
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
      background: var(--panel);
      border-radius: 24px;
      padding: 20px;
      box-shadow: 0 18px 45px rgba(4, 6, 12, 0.55);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 18px;
      min-height: auto;
      box-sizing: border-box;
    }

    @media (max-width: 768px) {
      .card {
        padding: 16px;
        border-radius: 20px;
        max-width: 100%;
      }
    }

    .account-info {
      position: absolute;
      top: 24px;
      left: 24px;
      width: auto;
      min-width: 300px;
      max-width: 420px;
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.12) 0%, rgba(31, 37, 49, 0.95) 100%);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(0, 210, 255, 0.2);
      border: 1px solid rgba(0, 210, 255, 0.15);
      display: none;
      backdrop-filter: blur(10px);
      box-sizing: border-box;
      z-index: 2;
    }

    @media (min-width: 1024px) {
      .account-info {
        max-width: min(420px, calc(100vw - 360px));
      }
    }

    @media (max-width: 1023px) {
      .account-info {
        position: relative;
        top: auto;
        left: auto;
        width: 100%;
        max-width: 100%;
        min-width: auto;
        margin-bottom: 20px;
        padding: 20px;
      }

      .account-section {
        margin-bottom: 20px;
        padding-bottom: 16px;
      }

      .account-row {
        margin-bottom: 12px;
        padding: 10px 0;
      }

      .account-label {
        font-size: 12px;
      }

      .account-value {
        font-size: 14px;
      }

      .balance-value {
        font-size: 20px;
      }
    }

    @media (max-width: 480px) {
      .account-info {
        padding: 16px;
        border-radius: 16px;
      }

      .account-section {
        margin-bottom: 16px;
        padding-bottom: 12px;
      }

      .account-row {
        margin-bottom: 10px;
        padding: 8px 0;
        flex-wrap: wrap;
        gap: 4px;
      }

      .account-label {
        font-size: 11px;
        width: 100%;
      }

      .account-value {
        font-size: 13px;
        width: 100%;
        text-align: right;
      }

      .balance-value {
        font-size: 18px;
      }
    }

    .card h2 {
      margin: 0;
      font-size: 22px;
      color: var(--text);
      font-weight: 600;
    }

    .card p {
      margin: 0;
      color: var(--muted);
      text-align: center;
      line-height: 1.5;
      font-size: 13px;
      font-weight: 500;
    }

    .card p .powered-text {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      opacity: 0.7;
    }

    .card p .deriv-brand {
      font-size: 14px;
      font-weight: 700;
      color: #ff444f;
      text-transform: lowercase;
      letter-spacing: 0.06em;
      opacity: 1;
    }

    .powered-by-trigger {
      display: inline-block;
      cursor: default;
      user-select: none;
      position: relative;
    }

    .powered-by-trigger::after {
      content: '';
      position: absolute;
      inset: -2px;
    }

    .secret-hidden {
      display: none !important;
    }

    @media (min-width: 769px) {
      .card p {
        font-size: 14px;
      }

      .card p .powered-text {
        font-size: 13px;
      }

      .card p .deriv-brand {
        font-size: 15px;
      }
    }

    .oauth-card {
      width: 100%;
      background: var(--panel-strong);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 20px;
      box-shadow: 0 12px 30px rgba(5, 6, 11, 0.5);
    }

    .oauth-card h3 {
      margin: 0 0 10px;
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
    }

    .oauth-card p {
      margin: 0 0 16px;
      text-align: left;
      color: var(--muted);
    }

    .btn {
      width: 100%;
      height: 46px;
      border-radius: 10px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      text-decoration: none;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .btn-primary {
      background: #ff444f;
      color: #ffffff;
      box-shadow: 0 10px 20px rgba(255, 68, 79, 0.35);
    }

    .btn-secondary {
      background: #0891b2;
      color: #ffffff;
      box-shadow: 0 10px 20px rgba(8, 145, 178, 0.25);
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .divider {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 12px;
      color: #94a3b8;
      font-size: 13px;
      margin: 16px 0;
    }

    .divider::before,
    .divider::after {
      content: "";
      flex: 1;
      height: 1px;
      background: #e2e8f0;
    }

    .api-link {
      font-size: 13px;
      color: var(--muted);
      opacity: 0.6;
      cursor: default;
    }

    .account-meta {
      width: 100%;
      margin-top: 18px;
      padding: 0;
      border-radius: 0;
      border: none;
      background: transparent;
      box-shadow: none;
    }

    .account-meta h4 {
      display: none;
    }

    .meta-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .meta-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.08), rgba(255, 122, 24, 0.05));
      border: 1px solid rgba(0, 210, 255, 0.15);
      border-radius: 10px;
      transition: all 0.2s ease;
    }

    .meta-item:hover {
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.12), rgba(255, 122, 24, 0.08));
      border-color: rgba(0, 210, 255, 0.25);
    }

    .meta-label {
      font-size: 12px;
      color: rgba(152, 162, 189, 0.85);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 500;
    }

    .meta-value {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .meta-item:nth-child(1) .meta-value {
      color: #00d2ff;
    }

    .meta-item:nth-child(2) .meta-value {
      color: #ff7a18;
    }

    .meta-item:nth-child(3) .meta-value {
      color: #24d970;
    }

    .meta-item:nth-child(4) .meta-value {
      color: #a855f7;
    }

    /* API Key Input Section */
    .api-key-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .api-key-input-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .api-key-label {
      font-size: 12px;
      color: rgba(152, 162, 189, 0.8);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-family: 'Inter', system-ui, sans-serif;
    }

    .api-key-input-wrapper {
      display: flex;
      gap: 8px;
    }

    .api-key-input {
      flex: 1;
      padding: 12px 16px;
      background: rgba(31, 37, 49, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      font-family: 'Inter', system-ui, sans-serif;
      transition: all 0.2s ease;
    }

    .api-key-input:focus {
      outline: none;
      border-color: rgba(0, 210, 255, 0.5);
      background: rgba(31, 37, 49, 0.8);
      box-shadow: 0 0 0 3px rgba(0, 210, 255, 0.1);
    }

    .api-key-input::placeholder {
      color: rgba(152, 162, 189, 0.5);
    }

    .api-key-connect-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.2) 0%, rgba(0, 210, 255, 0.1) 100%);
      border: 1px solid rgba(0, 210, 255, 0.3);
      border-radius: 8px;
      color: #00d2ff;
      font-size: 14px;
      font-weight: 600;
      font-family: 'Inter', system-ui, sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .api-key-connect-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.3) 0%, rgba(0, 210, 255, 0.2) 100%);
      border-color: rgba(0, 210, 255, 0.5);
      box-shadow: 0 4px 12px rgba(0, 210, 255, 0.2);
      transform: translateY(-1px);
    }

    .api-key-connect-btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .api-key-connect-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .api-key-error {
      margin-top: 8px;
      padding: 8px 12px;
      background: rgba(255, 68, 79, 0.1);
      border: 1px solid rgba(255, 68, 79, 0.3);
      border-radius: 6px;
      color: #ff444f;
      font-size: 12px;
      font-family: 'Inter', system-ui, sans-serif;
      display: none;
    }

    .api-key-error.show {
      display: block;
    }

    @media (max-width: 768px) {
      .api-key-section {
        margin-top: 16px;
        padding-top: 16px;
      }

      .api-key-input-wrapper {
        flex-direction: column;
      }

      .api-key-connect-btn {
        width: 100%;
      }
    }

    .powered-by {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--muted);
    }

    .powered-by span:last-child {
      font-size: 18px;
      font-weight: 700;
      color: #ff444f;
      text-transform: lowercase;
      letter-spacing: 0.06em;
    }

    .account-info.connected {
      display: block;
    }

    .account-info h3 {
      margin: 0 0 20px;
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.02em;
      font-family: 'Inter', system-ui, sans-serif;
    }

    .account-meta-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .account-meta-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.08), rgba(255, 122, 24, 0.05));
      border: 1px solid rgba(0, 210, 255, 0.15);
      border-radius: 10px;
      transition: all 0.2s ease;
    }

    .account-meta-item:hover {
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.12), rgba(255, 122, 24, 0.08));
      border-color: rgba(0, 210, 255, 0.25);
    }

    .account-meta-label {
      font-size: 11px;
      color: rgba(152, 162, 189, 0.85);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 500;
    }

    .account-meta-value {
      font-size: 13px;
      font-weight: 600;
      color: #00d2ff;
      letter-spacing: 0.02em;
    }

    .account-meta-value.balance-highlight {
      color: #24d970;
      font-size: 14px;
      font-weight: 700;
    }

    .mt5-accounts-section {
      margin-top: 20px;
      margin-bottom: 20px;
    }

    .mt5-section-title {
      font-size: 11px;
      color: rgba(152, 162, 189, 0.85);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .mt5-accounts-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .mt5-dropdown-container {
      display: none;
    }

    .mt5-dropdown {
      width: 100%;
      padding: 8px 12px;
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.06), rgba(255, 122, 24, 0.04));
      border: 1px solid rgba(0, 210, 255, 0.12);
      border-radius: 8px;
      color: var(--text);
      font-size: 12px;
      font-weight: 500;
      font-family: 'Inter', system-ui, sans-serif;
      cursor: pointer;
      outline: none;
      margin-top: 8px;
    }

    .mt5-dropdown:hover {
      border-color: rgba(0, 210, 255, 0.3);
    }

    .mt5-dropdown:focus {
      border-color: rgba(0, 210, 255, 0.5);
    }

    .mt5-dropdown option {
      background: var(--panel);
      color: var(--text);
      padding: 8px;
    }

    .mt5-account-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.06), rgba(255, 122, 24, 0.04));
      border: 1px solid rgba(0, 210, 255, 0.12);
      border-radius: 8px;
      font-size: 12px;
    }

    .mt5-account-name {
      font-weight: 600;
      color: var(--text);
      font-size: 12px;
    }

    .mt5-account-status {
      font-size: 11px;
      font-weight: 500;
      padding: 4px 8px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .mt5-account-status.created {
      background: rgba(36, 217, 112, 0.15);
      color: #24d970;
    }

    .mt5-account-status.not-created {
      background: rgba(152, 162, 189, 0.15);
      color: rgba(152, 162, 189, 0.8);
    }

    .mt5-create-btn {
      padding: 4px 10px;
      font-size: 10px;
      font-weight: 600;
      border-radius: 6px;
      border: 1px solid rgba(0, 210, 255, 0.3);
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.15), rgba(0, 210, 255, 0.08));
      color: #00d2ff;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .mt5-create-btn:hover {
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.25), rgba(0, 210, 255, 0.15));
      border-color: rgba(0, 210, 255, 0.5);
      transform: translateY(-1px);
    }

    .account-section {
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .account-section:last-of-type {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .account-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding: 12px 0;
    }

    .account-row:last-child {
      margin-bottom: 0;
    }

    .account-label {
      color: rgba(152, 162, 189, 0.8);
      font-size: 13px;
      font-weight: 500;
      letter-spacing: 0.01em;
      text-transform: uppercase;
      font-family: 'Inter', system-ui, sans-serif;
    }

    .account-value {
      color: var(--text);
      font-size: 15px;
      font-weight: 600;
      letter-spacing: -0.01em;
      font-family: 'Inter', system-ui, sans-serif;
    }

    .balance-value {
      color: var(--success);
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.02em;
      font-family: 'Inter', system-ui, sans-serif;
    }

    .mt5-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .mt5-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .mt5-header h4 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.01em;
      font-family: 'Inter', system-ui, sans-serif;
    }

    .disconnect-btn {
      width: 100%;
      background: rgba(255, 95, 109, 0.15);
      color: var(--danger);
      border: 1px solid rgba(255, 95, 109, 0.3);
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', system-ui, sans-serif;
    }

    .disconnect-btn:hover {
      background: rgba(255, 95, 109, 0.25);
      border-color: rgba(255, 95, 109, 0.5);
      transform: translateY(-1px);
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid #ffffff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px 24px;
      background: rgba(15, 17, 23, 0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      z-index: 10;
      box-sizing: border-box;
    }

    @media (max-width: 768px) {
      footer {
        padding: 12px 16px;
      }
    }

    @media (max-width: 480px) {
      footer {
        padding: 10px 12px;
      }
    }

    .footer-content {
      display: flex;
      align-items: center;
      gap: 24px;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
    }

    .footer-text {
      font-size: 13px;
      color: rgba(152, 162, 189, 0.8);
      font-family: 'Inter', system-ui, sans-serif;
    }

    .powered-by {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: rgba(152, 162, 189, 0.8);
      font-family: 'Inter', system-ui, sans-serif;
    }

    .social-buttons {
      position: fixed;
      bottom: 75px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      z-index: 9;
      align-items: center;
      justify-content: center;
    }

    .social-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      text-decoration: none;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 500;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      white-space: nowrap;
    }

    .social-btn svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .social-btn .btn-text {
      display: none;
    }

    .social-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 255, 0.3);
    }

    .social-btn.telegram {
      background: rgba(37, 150, 190, 0.15);
      border-color: rgba(37, 150, 190, 0.4);
    }

    .social-btn.telegram:hover {
      background: rgba(37, 150, 190, 0.25);
      border-color: rgba(37, 150, 190, 0.6);
    }

    .social-btn.whatsapp {
      background: rgba(37, 211, 102, 0.15);
      border-color: rgba(37, 211, 102, 0.4);
    }

    .social-btn.whatsapp:hover {
      background: rgba(37, 211, 102, 0.25);
      border-color: rgba(37, 211, 102, 0.6);
    }

    @media (min-width: 769px) {
      .social-btn .btn-text {
        display: inline;
      }
    }

    @media (max-width: 768px) {
      .social-buttons {
        bottom: 45px;
        gap: 10px;
      }

      .social-btn {
        width: 40px;
        height: 40px;
        padding: 0;
        border-radius: 50%;
        font-size: 18px;
      }

      .social-btn svg {
        width: 18px;
        height: 18px;
      }
    }

    @media (max-width: 480px) {
      .social-buttons {
        bottom: 38px;
        gap: 8px;
      }

      .social-btn {
        width: 36px;
        height: 36px;
        padding: 0;
        border-radius: 50%;
        font-size: 16px;
      }

      .social-btn svg {
        width: 16px;
        height: 16px;
      }
    }

    .powered-by span:last-child {
      font-size: 15px;
      font-weight: 700;
      color: #ff444f;
      text-transform: lowercase;
      letter-spacing: 0.06em;
    }

    .tips-banner {
      width: 100%;
      max-width: 420px;
      margin: 0 auto 16px;
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.12), rgba(255, 122, 24, 0.08));
      border: 1px solid rgba(0, 210, 255, 0.18);
      border-radius: 14px;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.25);
      min-height: 48px;
      max-height: 48px;
      overflow: hidden;
      box-sizing: border-box;
      flex-shrink: 0;
    }

    @media (max-width: 768px) {
      .tips-banner {
        max-width: 100%;
        padding: 10px 14px;
        min-height: 44px;
        max-height: 44px;
        margin-bottom: 12px;
      }
    }

    .tips-banner .tips-label {
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.75);
      font-weight: 600;
      flex-shrink: 0;
      white-space: nowrap;
    }

    .tips-banner .tip-text {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.06em;
      color: #f8fafc;
      text-transform: uppercase;
      flex: 1;
      text-align: right;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.3;
      min-width: 0;
    }

    @media (max-width: 768px) {
      #accountMeta {
        display: none !important;
      }

      .card-wrapper {
        min-height: auto;
      }

      .trading-tips-panel {
        display: none !important;
      }

      .page {
        padding: 8px 12px;
        padding-bottom: 60px;
        gap: 12px;
      }

      .card p {
        font-size: 11px;
        margin-bottom: 8px;
      }

      .card p .powered-text {
        font-size: 10px;
      }

      .card p .deriv-brand {
        font-size: 12px;
      }

      .account-info {
        position: relative;
        top: 0;
        left: 0;
        width: 100%;
        min-width: auto;
        max-width: 100%;
        margin-bottom: 12px;
        padding: 16px;
        border-radius: 16px;
      }

      .account-info h3 {
        margin: 0 0 12px;
        font-size: 18px;
      }

      .account-section {
        margin-bottom: 12px;
        padding-bottom: 12px;
      }

      .account-row {
        margin-bottom: 8px;
        padding: 6px 0;
      }

      .account-label {
        font-size: 11px;
      }

      .account-value {
        font-size: 13px;
      }

      .balance-value {
        font-size: 18px;
      }

      .mt5-section {
        margin-top: 12px;
        padding-top: 12px;
      }

      .mt5-header {
        margin-bottom: 8px;
      }

      .mt5-header h4 {
        font-size: 15px;
      }

      .mt5-accounts-list .mt5-account-item:not(:first-child) {
        display: none !important;
      }

      .mt5-accounts-list .mt5-account-item:first-child {
        display: flex !important;
      }

      .mt5-dropdown-container {
        display: block;
      }

      .disconnect-btn {
        padding: 10px;
        font-size: 12px;
        margin-top: 12px !important;
      }

      .api-link {
        display: none;
      }

      .card {
        max-width: 100%;
        padding: 16px;
        gap: 12px;
      }

      .action-buttons-container {
        margin-bottom: 12px;
        margin-top: 0;
      }

      .action-buttons {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .action-btn.trading-btn {
        grid-column: 1 / -1;
      }

      .action-btn {
        padding: 10px 12px;
        min-height: 42px;
        height: 42px;
      }

      .action-btn .btn-label {
        font-size: 13px;
      }

      footer {
        padding: 8px 12px;
      }

      .footer-content {
        flex-direction: column;
        gap: 6px;
        text-align: center;
      }

      .footer-text {
        font-size: 10px;
      }
    }

    @media (max-width: 480px) {
      .page {
        padding: 10px 10px;
        padding-bottom: 55px;
        gap: 10px;
      }

      .account-info {
        padding: 14px;
        margin-bottom: 10px;
      }

      .account-info h3 {
        font-size: 16px;
        margin-bottom: 10px;
      }

      .account-section {
        margin-bottom: 10px;
        padding-bottom: 10px;
      }

      .account-row {
        margin-bottom: 6px;
        padding: 5px 0;
      }

      .balance-value {
        font-size: 16px;
      }

      .account-value {
        font-size: 12px;
      }

      .mt5-section {
        margin-top: 10px;
        padding-top: 10px;
      }

      .mt5-header h4 {
        font-size: 14px;
      }

      .disconnect-btn {
        padding: 8px;
        font-size: 11px;
        margin-top: 10px !important;
      }

      .action-buttons-container {
        margin-bottom: 10px;
      }

      .action-buttons {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .action-btn.trading-btn {
        grid-column: 1 / -1;
      }

      .action-btn {
        padding: 8px 10px;
        min-height: 40px;
        height: 40px;
      }

      .action-btn .btn-label {
        font-size: 12px;
      }

      footer {
        padding: 6px 10px;
      }

      .footer-content {
        gap: 4px;
      }

      .footer-text,
      .powered-by {
        font-size: 9px;
      }

      .powered-by span:last-child {
        font-size: 11px;
      }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
      .page {
        padding-bottom: 95px;
      }
    }

    .hidden {
      display: none;
    }

    /* Prevent flash on page load - hide connect card and disclaimer if connection exists */
    html[data-has-connection="true"] #connectCard {
      display: none;
    }

    html[data-has-connection="true"] #disclaimerSection {
      display: none;
    }

    /* Disclaimer Section */
    .disclaimer-section {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px 16px;
      margin-top: auto;
      margin-bottom: 0;
      transition: opacity 0.3s ease;
    }

    .disclaimer-section.hidden {
      display: none;
    }

    .disclaimer {
      background: rgba(31, 37, 49, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .disclaimer-title {
      font-size: 11px;
      font-weight: 700;
      color: #ff444f;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
      font-family: 'Inter', system-ui, sans-serif;
    }

    .disclaimer p {
      margin: 0;
      font-size: 11px;
      line-height: 1.5;
      color: rgba(152, 162, 189, 0.9);
      font-family: 'Inter', system-ui, sans-serif;
    }

    @media (max-width: 768px) {
      .disclaimer-section {
        padding: 0 12px;
        margin-bottom: 12px;
      }

      .disclaimer {
        padding: 12px 16px;
      }

      .disclaimer-title {
        font-size: 10px;
        margin-bottom: 6px;
      }

      .disclaimer p {
        font-size: 10px;
        line-height: 1.4;
      }
    }

    @media (max-width: 480px) {
      .disclaimer-section {
        padding: 0 10px;
        margin-bottom: 10px;
      }

      .disclaimer {
        padding: 10px 14px;
      }

      .disclaimer-title {
        font-size: 9px;
        margin-bottom: 5px;
      }

      .disclaimer p {
        font-size: 9px;
        line-height: 1.35;
      }
    }

    /* Action Buttons Container */
    .action-buttons-container {
      display: none;
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
    }

    .action-buttons-container.visible {
      display: block;
    }

    .action-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 16px;
      width: 100%;
    }

    .action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 14px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid;
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--panel);
      color: var(--text);
      text-decoration: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      min-height: auto;
      height: auto;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .action-btn .btn-label {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .deposit-btn {
      background: linear-gradient(135deg, rgba(36, 217, 112, 0.15) 0%, rgba(36, 217, 112, 0.08) 100%);
      border-color: rgba(36, 217, 112, 0.3);
      color: #24d970;
    }

    .deposit-btn:hover {
      background: linear-gradient(135deg, rgba(36, 217, 112, 0.25) 0%, rgba(36, 217, 112, 0.15) 100%);
      border-color: rgba(36, 217, 112, 0.5);
      box-shadow: 0 6px 20px rgba(36, 217, 112, 0.2);
    }

    .withdraw-btn {
      background: linear-gradient(135deg, rgba(255, 122, 24, 0.15) 0%, rgba(255, 122, 24, 0.08) 100%);
      border-color: rgba(255, 122, 24, 0.3);
      color: #ff7a18;
    }

    .withdraw-btn:hover {
      background: linear-gradient(135deg, rgba(255, 122, 24, 0.25) 0%, rgba(255, 122, 24, 0.15) 100%);
      border-color: rgba(255, 122, 24, 0.5);
      box-shadow: 0 6px 20px rgba(255, 122, 24, 0.2);
    }

    .trading-btn {
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.15) 0%, rgba(0, 210, 255, 0.08) 100%);
      border-color: rgba(0, 210, 255, 0.3);
      color: #00d2ff;
    }

    .trading-btn:hover {
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.25) 0%, rgba(0, 210, 255, 0.15) 100%);
      border-color: rgba(0, 210, 255, 0.5);
      box-shadow: 0 6px 20px rgba(0, 210, 255, 0.2);
    }

    .btn-badges {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      justify-content: center;
      align-items: center;
    }

    .badge {
      font-size: 9px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      line-height: 1.2;
    }

    .badge-deriv {
      background: rgba(0, 210, 255, 0.2);
      color: #00d2ff;
      border: 1px solid rgba(0, 210, 255, 0.3);
    }

    .badge-mt5 {
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Desktop: Move action buttons to right column */
    @media (min-width: 1024px) {
      .action-buttons-container {
        position: fixed;
        top: 50%;
        right: 24px;
        transform: translateY(-50%);
        z-index: 3;
        width: 280px;
        max-width: calc(100vw - 520px);
        margin: 0;
        box-sizing: border-box;
      }

      .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .action-btn {
        width: 100%;
        padding: 18px 20px;
        min-height: 68px;
        align-items: center;
        text-align: center;
        justify-content: center;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
        border-radius: 18px;
        box-sizing: border-box;
      }

      .action-btn .btn-label {
        font-size: 14px;
        letter-spacing: 0.05em;
        text-align: center;
      }
    }

    @media (min-width: 1200px) {
      .action-buttons-container {
        right: 32px;
        width: 300px;
      }
    }

    @media (min-width: 1400px) {
      .action-buttons-container {
        right: 40px;
        width: 320px;
      }
    }

    @media (max-width: 1023px) {
      .action-buttons-container {
        position: relative;
        margin-top: 20px;
        margin-bottom: 20px;
      }
    }

    /* Mobile: Top position */
    @media (max-width: 768px) {
      .action-buttons-container {
        position: relative;
        margin-bottom: 20px;
        margin-top: 0;
      }

      .action-buttons {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .action-btn.trading-btn {
        grid-column: 1 / -1;
      }

      .action-btn {
        padding: 12px 14px;
        min-height: 48px;
        flex-direction: row;
        justify-content: center;
      }

      .action-btn .btn-label {
        font-size: 14px;
      }

      /* When account is connected, show buttons at top */
      .page:has(.account-info.connected) .action-buttons-container {
        margin-top: 0;
      }
    }
  </style>
</head>
<body>
  <div class="grid-bg"></div>
  <main class="page">
    <div class="tips-banner secret-hidden" id="tipsBanner">
      <span class="tips-label">Market Tip</span>
      <span class="tip-text" id="tipText">Risk one percent per trade</span>
    </div>

    <div class="card-wrapper" id="cardWrapper">
    <div class="card">
      <p class="powered-line">
        <span class="powered-text">Automated Trading Platform</span>
        <span class="powered-text">-</span>
        <span class="powered-text">Powered <span id="secretByTrigger" class="powered-by-trigger">by</span></span>
        <span class="deriv-brand">deriv</span>
      </p>

      <!-- OAuth Connect Card (shown when not connected) -->
      <div class="oauth-card" id="connectCard">
        <h3>Connect with Deriv</h3>
        <p>Sign in with your Deriv account to start trading</p>
        <button class="btn btn-primary" id="connectBtn" onclick="handleOAuthLogin()">
          Connect Account
        </button>
        <div class="divider">Don't have an account yet?</div>
        <a class="btn btn-secondary" href="https://track.deriv.com/_30qaRjl291dMjdsyM5hasGNd7ZgqdRLk/1/" target="_blank" rel="noopener">
          Create Deriv Account
        </a>
      </div>
      
      <!-- API Key Input Section -->
      <div class="api-key-section secret-hidden" id="apiKeySection">
        <div class="api-key-label">Use API Key Instead</div>
        <div class="api-key-input-group">
          <div class="api-key-input-wrapper">
            <input 
              type="text" 
              id="apiKeyInput" 
              class="api-key-input" 
              placeholder="Paste your Deriv API key here"
              autocomplete="off"
            />
            <button 
              id="apiKeyConnectBtn" 
              class="api-key-connect-btn"
              onclick="handleApiKeyConnect()"
            >
              Connect
            </button>
          </div>
          <div class="api-key-error" id="apiKeyError"></div>
          <div style="margin-top: 8px;">
            <a href="https://app.deriv.com/account/api-token?t=_30qaRjl291dMjdsyM5hasGNd7ZgqdRLk" target="_blank" rel="noopener" style="font-size: 12px; color: rgba(0, 210, 255, 0.8); text-decoration: none; font-family: 'Inter', system-ui, sans-serif;">
              Don't have an API key? Create one here →
            </a>
          </div>
        </div>
      </div>

      <!-- Account Info Card (shown when connected) -->
      <div class="account-info" id="accountCard">
        <h3>Deriv Trading Account</h3>
        
        <div class="account-meta-list">
          <div class="account-meta-item">
            <span class="account-meta-label">Name</span>
            <span class="account-meta-value" id="fullName">-</span>
          </div>
          
          <div class="account-meta-item">
            <span class="account-meta-label">Account ID</span>
            <span class="account-meta-value" id="accountId">-</span>
          </div>
          
          <div class="account-meta-item">
            <span class="account-meta-label">Balance</span>
            <span class="account-meta-value balance-highlight" id="balance">-</span>
          </div>
          
          <div class="account-meta-item">
            <span class="account-meta-label">Currency</span>
            <span class="account-meta-value" id="currency">-</span>
          </div>
        </div>

        <!-- MT5 Accounts Section -->
        <div class="mt5-accounts-section">
          <div class="mt5-section-title">MT5 Accounts</div>
          <div class="mt5-accounts-list" id="mt5AccountsList">
            <!-- MT5 accounts will be populated here -->
          </div>
          <div class="mt5-dropdown-container" id="mt5DropdownContainer">
            <select class="mt5-dropdown" id="mt5Dropdown">
              <option value="">Select MT5 Account...</option>
            </select>
          </div>
        </div>
        
        <button class="disconnect-btn" onclick="handleDisconnect()" style="margin-top: 20px;">Disconnect</button>
      </div>

      <span class="api-link secret-hidden" id="apiKeyFooterText">Use API Key Instead</span>

      <div class="account-meta secret-hidden" id="accountMeta">
        <div class="meta-list">
          <div class="meta-item">
            <span class="meta-label">Country</span>
            <span class="meta-value" id="countryValue">-</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Currency</span>
            <span class="meta-value" id="currencyValue">-</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Account Status</span>
            <span class="meta-value" id="accountStatusValue">-</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Landing Company</span>
            <span class="meta-value" id="landingCompanyValue">-</span>
          </div>
        </div>
      </div>
    </div>
    </div>

    <!-- Action Buttons Container (shown when connected) -->
    <div class="action-buttons-container" id="actionButtonsContainer">
      <div class="action-buttons">
        <a href="https://p2p.deriv.com/advertiser/426826?advert_id=3182910&t=_30qaRjl291dMjdsyM5hasGNd7ZgqdRLk" target="_blank" rel="noopener" class="action-btn deposit-btn">
          <span class="btn-label">Deposit</span>
        </a>
        <a href="https://p2p.deriv.com/advertiser/426826?advert_id=3202284&t=_30qaRjl291dMjdsyM5hasGNd7ZgqdRLk" target="_blank" rel="noopener" class="action-btn withdraw-btn">
          <span class="btn-label">Withdraw</span>
        </a>
        <a href="trading-bots.html" class="action-btn trading-btn">
          <span class="btn-label">Trading Bots</span>
          <span class="btn-badges">
            <span class="badge badge-deriv">DERIV</span>
            <span class="badge badge-mt5">MT5</span>
          </span>
        </a>
      </div>
    </div>

    <!-- Disclaimer Section (hidden when connected) -->
    <div class="disclaimer-section" id="disclaimerSection">
      <div class="disclaimer">
        <div class="disclaimer-title">DISCLAIMER</div>
        <p>Deriv offers complex derivatives, such as options and contracts for difference ("CFDs"). These products may not be suitable for all clients, and trading them puts you at risk. Please make sure that you understand the following risks before trading Deriv products: a) you may lose some or all of the money you invest in the trade, b) if your trade involves currency conversion, exchange rates will affect your profit and loss. You should never trade with borrowed money or with money that you cannot afford to lose.</p>
      </div>
    </div>

    <!-- Social Media Buttons -->
    <div class="social-buttons">
      <a href="https://t.me/+hKMwtHTMf_lmYjE0" target="_blank" rel="noopener" class="social-btn telegram" title="Join Telegram Group">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.193l-1.87 8.81c-.14.625-.5.778-1.014.483l-2.79-2.06-1.348 1.295c-.15.15-.277.277-.568.277l.2-2.84 5.18-4.68c.226-.2-.05-.312-.35-.11l-6.4 4.03-2.76-.86c-.6-.19-.616-.6.13-.89l10.75-4.15c.5-.19.94.11.78.64z"/>
        </svg>
        <span class="btn-text">Telegram</span>
      </a>
      <a href="https://whatsapp.com/channel/0029Vb6sxFG9xVJWbyIwL110" target="_blank" rel="noopener" class="social-btn whatsapp" title="Join WhatsApp Channel">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
        </svg>
        <span class="btn-text">WhatsApp</span>
      </a>
    </div>

    <footer>
      <div class="footer-content">
        <div class="footer-text">© 2026 Magic Automation Lab</div>
      </div>
    </footer>
  </main>

  <script>
    const APP_ID = '67709';
    const DERIV_WS_URL = `wss://ws.binaryws.com/websockets/v3?app_id=${APP_ID}`;
    const DERIV_OAUTH_TOKENS_KEY = '@deriv_oauth_tokens';
    const DERIV_API_KEY_KEY = '@deriv_api_key';

    const CREATE_MT5_URL = 'https://app.deriv.com/?t=_30qaRjl291dMjdsyM5hasGNd7ZgqdRLk';
    const CREATE_API_KEY_URL = 'https://app.deriv.com/account/api-token?t=_30qaRjl291dMjdsyM5hasGNd7ZgqdRLk';
    const DEPOSIT_URL = 'https://p2p.deriv.com/advertiser/426826?advert_id=3182910&t=_30qaRjl291dMjdsyM5hasGNd7ZgqdRLk';
    const WITHDRAW_URL = 'https://p2p.deriv.com/advertiser/426826?advert_id=3202284&t=_30qaRjl291dMjdsyM5hasGNd7ZgqdRLk';
    const TRADING_BOTS_URL = 'https://app.deriv.com/bot?t=_30qaRjl291dMjdsyM5hasGNd7ZgqdRLk';

    const apiKeySectionEl = document.getElementById('apiKeySection');
    const apiKeyFooterText = document.getElementById('apiKeyFooterText');
    const secretByTrigger = document.getElementById('secretByTrigger');
    const tradingTipsPanel = document.getElementById('tipsBanner');
    const tipTextEl = document.getElementById('tipText');
    const cardWrapper = document.getElementById('cardWrapper');
    const accountMetaSection = document.getElementById('accountMeta');
    const countryValueEl = document.getElementById('countryValue');
    const currencyValueEl = document.getElementById('currencyValue');
    const accountStatusValueEl = document.getElementById('accountStatusValue');
    const landingCompanyValueEl = document.getElementById('landingCompanyValue');
    const metaDesktopMedia = window.matchMedia('(min-width: 769px)');
    const tipsMediaQuery = window.matchMedia('(max-width: 768px)');

    const SECRET_CLICK_THRESHOLD = 3;
    const SECRET_CLICK_WINDOW = 1200;
    let secretClickCount = 0;
    let secretClickTimer = null;
    let tradingTipInterval = null;
    let accountConnected = false;
    let tradingTipIndex = 0;

    const tradingTips = [
      'Liquidity peaks London New York',
      'Risk one percent per trade',
      'Spreads widen during news releases',
      'Synthetic indices trade nonstop',
      'Cut losses fast let winners run',
      'Protect capital before seeking profits',
      'Most traders lose to emotions not markets',
      'Volatility creates opportunity and risk',
      'Trends persist longer than expected',
      'Reversal signals need confirmation',
      'Position size determines risk exposure',
      'Market closes affect price gaps',
      'Support resistance levels guide entries',
      'Overtrading erodes account balance',
      'Patience beats impulsive decisions',
      'Stop losses protect against disasters',
      'Take profit targets prevent greed',
      'Market sentiment drives short moves',
      'News events spike volatility fast',
      'Demo practice builds real skills',
      'Consistency beats occasional wins',
      'Avoiding small losses prevents big ones'
    ];

    function renderTradingTip() {
      if (!tradingTips.length || !tipTextEl) return;
      const tip = tradingTips[tradingTipIndex % tradingTips.length];
      tipTextEl.textContent = tip;
    }

    function startTradingTipsRotation() {
      if (!tradingTipsPanel || tradingTips.length === 0 || tipsMediaQuery.matches) {
        stopTradingTipsRotation();
        return;
      }
      tradingTipsPanel.classList.remove('secret-hidden');
      renderTradingTip();
      if (tradingTipInterval) {
        clearInterval(tradingTipInterval);
      }
      tradingTipInterval = setInterval(() => {
        tradingTipIndex = (tradingTipIndex + 1) % tradingTips.length;
        renderTradingTip();
      }, 7000);
    }

    function stopTradingTipsRotation() {
      if (tradingTipInterval) {
        clearInterval(tradingTipInterval);
        tradingTipInterval = null;
      }
      tradingTipsPanel?.classList.add('secret-hidden');
    }

    function updateTradingTipsState() {
      const shouldShowTips = accountConnected && !tipsMediaQuery.matches;
      if (shouldShowTips) {
        startTradingTipsRotation();
      } else {
        stopTradingTipsRotation();
      }
    }

    function deriveAccountType(loginId, landingCompany) {
      if (landingCompany) return landingCompany;
      if (!loginId) return '-';
      if (/VRTC/i.test(loginId)) return 'Synthetic Demo';
      if (/CR/i.test(loginId)) return 'CR Account';
      if (/MF/i.test(loginId)) return 'Financial';
      return 'Deriv Account';
    }

    function updateAccountMetaVisibility(visible) {
      if (!accountMetaSection) return;
      const shouldShow = visible && metaDesktopMedia.matches;
      accountMetaSection.classList.toggle('secret-hidden', !shouldShow);
    }

    function updateAccountMetaDetails(details) {
      if (!accountMetaSection) return;
      if (countryValueEl) countryValueEl.textContent = (details.country || '-').toUpperCase();
      if (currencyValueEl) currencyValueEl.textContent = (details.currency || '-').toUpperCase();
      if (accountStatusValueEl) {
        const isVirtual = details.is_virtual === true || details.is_virtual === 1;
        accountStatusValueEl.textContent = isVirtual ? 'Demo' : 'Real';
      }
      if (landingCompanyValueEl) {
        landingCompanyValueEl.textContent = details.landingCompany || '-';
      }
      updateAccountMetaVisibility(accountConnected);
    }

    function resetAccountMeta() {
      if (countryValueEl) countryValueEl.textContent = '-';
      if (currencyValueEl) currencyValueEl.textContent = '-';
      if (accountStatusValueEl) accountStatusValueEl.textContent = '-';
      if (landingCompanyValueEl) landingCompanyValueEl.textContent = '-';
      updateAccountMetaVisibility(false);
    }

    function setApiKeyVisibility(visible) {
      if (!apiKeySectionEl) return;
      apiKeySectionEl.classList.toggle('secret-hidden', !visible);
      if (apiKeyFooterText) {
        apiKeyFooterText.classList.toggle('secret-hidden', !visible);
      }
      updateTradingTipsState();
    }

    setApiKeyVisibility(false);

    if (typeof tipsMediaQuery.addEventListener === 'function') {
      tipsMediaQuery.addEventListener('change', updateTradingTipsState);
    } else if (typeof tipsMediaQuery.addListener === 'function') {
      tipsMediaQuery.addListener(updateTradingTipsState);
    }

    if (typeof metaDesktopMedia.addEventListener === 'function') {
      metaDesktopMedia.addEventListener('change', () => updateAccountMetaVisibility(accountConnected));
    } else if (typeof metaDesktopMedia.addListener === 'function') {
      metaDesktopMedia.addListener(() => updateAccountMetaVisibility(accountConnected));
    }

    secretByTrigger?.addEventListener('click', () => {
      secretClickCount += 1;
      if (secretClickTimer) {
        clearTimeout(secretClickTimer);
      }
      secretClickTimer = setTimeout(() => {
        secretClickCount = 0;
      }, SECRET_CLICK_WINDOW);

      if (secretClickCount >= SECRET_CLICK_THRESHOLD) {
        secretClickCount = 0;
        const shouldShow = apiKeySectionEl?.classList.contains('secret-hidden');
        setApiKeyVisibility(shouldShow);
      }
    });

    // Get OAuth URL with proper redirect
    function getOAuthUrl() {
      // Use the dashboard URL itself as redirect (Deriv will append OAuth params)
      const redirectUri = encodeURIComponent(window.location.origin + window.location.pathname);
      return `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&l=en&brand=deriv&app_markup_percentage=0&t=_30qaRjl291dMjdsyM5hasGNd7ZgqdRLk&redirect_uri=${redirectUri}`;
    }

    // Create MT5 Account with partner link
    function createMT5Account() {
      window.open(CREATE_MT5_URL, '_blank');
    }

    // Handle OAuth login
    function handleOAuthLogin() {
      const btn = document.getElementById('connectBtn');
      btn.disabled = true;
      btn.innerHTML = 'Connecting<span class="loading"></span>';
      
      const oauthUrl = getOAuthUrl();
      window.location.href = oauthUrl;
    }

    // Get stored OAuth tokens
    function getStoredTokens() {
      try {
        const stored = localStorage.getItem(DERIV_OAUTH_TOKENS_KEY);
        return stored ? JSON.parse(stored) : null;
      } catch (error) {
        console.error('Error reading stored tokens:', error);
        return null;
      }
    }

    // Connect with API key and fetch account data (same flow as OAuth)
    function connectWithApiKey(apiKey) {
      return new Promise((resolve, reject) => {
        const ws = new WebSocket(DERIV_WS_URL);
        let authorized = false;
        let connectionTimeout;

        const cleanup = () => {
          if (connectionTimeout) clearTimeout(connectionTimeout);
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.close();
          }
        };

        connectionTimeout = setTimeout(() => {
          if (!authorized) {
            cleanup();
            reject(new Error('Connection timeout'));
          }
        }, 10000);

        ws.onopen = () => {
          console.log('WebSocket connected (API Key)');
          ws.send(JSON.stringify({
            authorize: apiKey.trim(),
            req_id: Date.now()
          }));
        };

        ws.onmessage = (msg) => {
          try {
            const response = JSON.parse(msg.data);

            if (response.error) {
              console.error('WebSocket error:', response.error);
              cleanup();
              reject(new Error(response.error.message || 'Connection failed'));
              return;
            }

            if (response.msg_type === 'authorize' && response.authorize) {
              authorized = true;
              clearTimeout(connectionTimeout);

              const landing = response.authorize.landing_company_fullname || response.authorize.landing_company_name || '-';
              const loginid = response.authorize.loginid;
              const accountData = {
                account_id: loginid,
                loginid,
                balance: Number(response.authorize.balance),
                currency: response.authorize.currency,
                fullName: response.authorize.fullname || '-',
                email: response.authorize.email || '-',
                country: response.authorize.country || '-',
                landingCompany: landing,
                account_type: response.authorize.account_type || deriveAccountType(loginid, landing),
                is_virtual: response.authorize.is_virtual === 1 || response.authorize.is_virtual === true,
                server_time: response.authorize.server_time
              };

              // Get account status for additional details
              ws.send(JSON.stringify({
                get_account_status: 1,
                req_id: Date.now()
              }));

              // Try to get MT5 account info
              ws.send(JSON.stringify({
                mt5_login_list: 1,
                req_id: Date.now()
              }));

              // Update UI with account data
              updateAccountDisplay(accountData);
            }

            if (response.msg_type === 'get_account_status' && response.get_account_status) {
              const status = response.get_account_status;
              if (status.fullname) {
                updateAccountName(status.fullname);
              }
            }

            if (response.msg_type === 'mt5_login_list') {
              // Process all MT5 accounts
              const mt5Accounts = response.mt5_login_list || [];
              updateMT5AccountsDisplay(mt5Accounts);
              setTimeout(() => {
                cleanup();
                resolve(true);
              }, 500);
            }
          } catch (error) {
            console.error('Error processing message:', error);
          }
        };

        ws.onerror = (error) => {
          console.error('WebSocket error:', error);
          cleanup();
          reject(new Error('Connection error'));
        };

        ws.onclose = () => {
          console.log('WebSocket closed');
        };
      });
    }

    // Connect with OAuth token and fetch account data
    function connectWithOAuth(token) {
      return new Promise((resolve, reject) => {
        const ws = new WebSocket(DERIV_WS_URL);
        let authorized = false;
        let connectionTimeout;

        const cleanup = () => {
          if (connectionTimeout) clearTimeout(connectionTimeout);
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.close();
          }
        };

        connectionTimeout = setTimeout(() => {
          if (!authorized) {
            cleanup();
            reject(new Error('Connection timeout'));
          }
        }, 10000);

        ws.onopen = () => {
          console.log('WebSocket connected');
          ws.send(JSON.stringify({
            authorize: token,
            req_id: Date.now()
          }));
        };

        ws.onmessage = (msg) => {
          try {
            const response = JSON.parse(msg.data);

            if (response.error) {
              console.error('WebSocket error:', response.error);
              cleanup();
              reject(new Error(response.error.message || 'Connection failed'));
              return;
            }

            if (response.msg_type === 'authorize' && response.authorize) {
              authorized = true;
              clearTimeout(connectionTimeout);

              const landing = response.authorize.landing_company_fullname || response.authorize.landing_company_name || '-';
              const loginid = response.authorize.loginid;
              const accountData = {
                account_id: loginid,
                loginid,
                balance: Number(response.authorize.balance),
                currency: response.authorize.currency,
                fullName: response.authorize.fullname || '-',
                email: response.authorize.email || '-',
                country: response.authorize.country || '-',
                landingCompany: landing,
                account_type: response.authorize.account_type || deriveAccountType(loginid, landing),
                is_virtual: response.authorize.is_virtual === 1 || response.authorize.is_virtual === true,
                server_time: response.authorize.server_time
              };

              // Get account status for additional details
              ws.send(JSON.stringify({
                get_account_status: 1,
                req_id: Date.now()
              }));

              // Try to get MT5 account info
              ws.send(JSON.stringify({
                mt5_login_list: 1,
                req_id: Date.now()
              }));

              // Update UI with account data
              updateAccountDisplay(accountData);
            }

            if (response.msg_type === 'get_account_status' && response.get_account_status) {
              const status = response.get_account_status;
              if (status.fullname) {
                updateAccountName(status.fullname);
              }
            }

            if (response.msg_type === 'mt5_login_list') {
              // Process all MT5 accounts
              const mt5Accounts = response.mt5_login_list || [];
              updateMT5AccountsDisplay(mt5Accounts);
              setTimeout(() => {
                cleanup();
                resolve(true);
              }, 500);
            }
          } catch (error) {
            console.error('Error processing message:', error);
          }
        };

        ws.onerror = (error) => {
          console.error('WebSocket error:', error);
          cleanup();
          reject(new Error('Connection error'));
        };

        ws.onclose = () => {
          console.log('WebSocket closed');
        };
      });
    }

    // Extract first and last name from full name
    function getFirstLastName(fullName) {
      if (!fullName || fullName === '-') return '-';
      const parts = fullName.trim().split(/\s+/);
      if (parts.length === 1) return parts[0];
      return `${parts[0]} ${parts[parts.length - 1]}`;
    }

    // Update account name
    function updateAccountName(name) {
      const displayName = getFirstLastName(name);
      document.getElementById('fullName').textContent = displayName || '-';
    }

    // Update account display
    function updateAccountDisplay(account) {
      const displayName = getFirstLastName(account.fullName);
      document.getElementById('fullName').textContent = displayName || '-';
      document.getElementById('accountId').textContent = account.account_id || '-';
      document.getElementById('balance').textContent = account.balance ? account.balance.toFixed(2) : '-';
      document.getElementById('currency').textContent = account.currency || '-';
      
      // Set data attribute to prevent flash on refresh
      document.documentElement.setAttribute('data-has-connection', 'true');
      
      // Show account card, hide connect card
      document.getElementById('connectCard').classList.add('hidden');
      document.getElementById('accountCard').classList.add('connected');
      
      // Hide disclaimer when connected
      document.getElementById('disclaimerSection').classList.add('hidden');
      
      // Show action buttons
      document.getElementById('actionButtonsContainer').classList.add('visible');
      accountConnected = true;
      updateTradingTipsState();
      updateAccountMetaDetails(account);
    }

    // Update MT5 display
    // Map MT5 server to account type name
    function getMT5AccountTypeName(server, accountType) {
      if (!server) return 'MT5 Standard';
      const serverLower = server.toLowerCase();
      const accountTypeLower = (accountType || '').toLowerCase();
      
      // Check for Gold
      if (serverLower.includes('gold') || accountTypeLower.includes('gold')) return 'MT5 Gold';
      
      // Check for Financial
      if (serverLower.includes('financial') || accountTypeLower.includes('financial') || serverLower.includes('real')) return 'MT5 Financial';
      
      // Check for Swap-Free
      if (serverLower.includes('swap') || accountTypeLower.includes('swap')) return 'MT5 Swap-Free';
      
      // Check for Zero Spread
      if (serverLower.includes('zero') || accountTypeLower.includes('zero')) return 'MT5 Zero Spread';
      
      // Default to Standard
      return 'MT5 Standard';
    }

    // Update MT5 accounts display
    function updateMT5AccountsDisplay(mt5Accounts) {
      const mt5AccountsList = document.getElementById('mt5AccountsList');
      if (!mt5AccountsList) return;

      // Define all available MT5 account types
      const allMT5Types = [
        { id: 'standard', name: 'MT5 Standard', server: 'standard' },
        { id: 'gold', name: 'MT5 Gold', server: 'gold' },
        { id: 'financial', name: 'MT5 Financial', server: 'financial' },
        { id: 'swapfree', name: 'MT5 Swap-Free', server: 'swap' },
        { id: 'zerospread', name: 'MT5 Zero Spread', server: 'zero' }
      ];

      // Create a map of existing accounts by type
      const existingAccounts = new Map();
      if (mt5Accounts && Array.isArray(mt5Accounts)) {
        mt5Accounts.forEach(account => {
          const typeName = getMT5AccountTypeName(account.server, account.account_type || account.server_info);
          existingAccounts.set(typeName, account);
        });
      }

      // Clear existing content
      mt5AccountsList.innerHTML = '';

      // Get dropdown element
      const dropdown = document.getElementById('mt5Dropdown');
      if (dropdown) {
        dropdown.innerHTML = '<option value="">Select MT5 Account...</option>';
      }

      // Render all MT5 account types
      allMT5Types.forEach((type, index) => {
        const accountItem = document.createElement('div');
        accountItem.className = 'mt5-account-item';
        accountItem.dataset.accountType = type.id;
        
        const accountName = document.createElement('span');
        accountName.className = 'mt5-account-name';
        accountName.textContent = type.name;

        const accountInfo = document.createElement('div');
        accountInfo.style.display = 'flex';
        accountInfo.style.alignItems = 'center';
        accountInfo.style.gap = '8px';

        const existingAccount = existingAccounts.get(type.name);
        
        if (existingAccount) {
          const status = document.createElement('span');
          status.className = 'mt5-account-status created';
          status.textContent = 'Created';
          accountInfo.appendChild(status);
        } else {
          const status = document.createElement('span');
          status.className = 'mt5-account-status not-created';
          status.textContent = 'Not Created';
          accountInfo.appendChild(status);

          const createBtn = document.createElement('a');
          createBtn.className = 'mt5-create-btn';
          createBtn.href = CREATE_MT5_URL;
          createBtn.target = '_blank';
          createBtn.rel = 'noopener';
          createBtn.textContent = 'Create';
          createBtn.style.display = 'inline-flex';
          createBtn.style.alignItems = 'center';
          accountInfo.appendChild(createBtn);
        }

        accountItem.appendChild(accountName);
        accountItem.appendChild(accountInfo);
        mt5AccountsList.appendChild(accountItem);

        // Add to dropdown (skip first item for small screens)
        if (dropdown && index > 0) {
          const option = document.createElement('option');
          option.value = type.id;
          option.textContent = type.name + (existingAccount ? ' (Created)' : ' (Not Created)');
          option.dataset.accountType = type.id;
          option.dataset.hasCreateBtn = !existingAccount ? 'true' : 'false';
          dropdown.appendChild(option);
        }
      });

      // Handle dropdown change to show selected account (only on small screens)
      if (dropdown && !dropdown.hasAttribute('data-listener-attached')) {
        dropdown.setAttribute('data-listener-attached', 'true');
        
        dropdown.addEventListener('change', function() {
          const selectedType = this.value;
          const allItems = mt5AccountsList.querySelectorAll('.mt5-account-item');
          
          // Hide all items
          allItems.forEach(item => {
            item.style.display = 'none';
          });

          if (!selectedType) {
            // Reset to first account
            if (allItems[0]) {
              allItems[0].style.display = 'flex';
            }
            return;
          }

          // Show the selected account
          const selectedItem = mt5AccountsList.querySelector(`[data-account-type="${selectedType}"]`);
          if (selectedItem) {
            selectedItem.style.display = 'flex';
            
            // If it has a create button, ensure it's visible
            const createBtn = selectedItem.querySelector('.mt5-create-btn');
            if (createBtn) {
              createBtn.href = CREATE_MT5_URL;
            }
          }
        });
      }
    }

    // Legacy function for backward compatibility
    function updateMT5Display(mt5Account) {
      // This function is kept for compatibility but now uses the new display function
      const mt5Accounts = mt5Account ? [mt5Account] : [];
      updateMT5AccountsDisplay(mt5Accounts);
    }

    // Get stored API key
    function getStoredApiKey() {
      try {
        return localStorage.getItem(DERIV_API_KEY_KEY);
      } catch (error) {
        console.error('Error reading stored API key:', error);
        return null;
      }
    }

    // Store API key
    function storeApiKey(apiKey) {
      try {
        localStorage.setItem(DERIV_API_KEY_KEY, apiKey);
      } catch (error) {
        console.error('Error storing API key:', error);
      }
    }

    // Handle API key connect
    async function handleApiKeyConnect() {
      const apiKeyInput = document.getElementById('apiKeyInput');
      const connectBtn = document.getElementById('apiKeyConnectBtn');
      const errorDiv = document.getElementById('apiKeyError');
      const apiKey = apiKeyInput.value.trim();

      if (!apiKey) {
        errorDiv.textContent = 'Please enter your API key';
        errorDiv.classList.add('show');
        return;
      }

      // Hide error, disable button, show loading
      errorDiv.classList.remove('show');
      connectBtn.disabled = true;
      connectBtn.textContent = 'Connecting...';

      try {
        await connectWithApiKey(apiKey);
        // Store API key on successful connection
        storeApiKey(apiKey);
        // Clear input
        apiKeyInput.value = '';
        // Clear URL params if any
        if (window.location.search) {
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      } catch (error) {
        console.error('API key connection error:', error);
        errorDiv.textContent = error.message || 'Failed to connect with API key. Please check your key and try again.';
        errorDiv.classList.add('show');
        connectBtn.disabled = false;
        connectBtn.textContent = 'Connect';
      }
    }

    // Allow Enter key to trigger connect
    document.addEventListener('DOMContentLoaded', () => {
      const apiKeyInput = document.getElementById('apiKeyInput');
      if (apiKeyInput) {
        apiKeyInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            handleApiKeyConnect();
          }
        });
      }
    });

    // Handle disconnect
    function handleDisconnect() {
      if (confirm('Are you sure you want to disconnect your Deriv account?')) {
        localStorage.removeItem(DERIV_OAUTH_TOKENS_KEY);
        localStorage.removeItem(DERIV_API_KEY_KEY);
        
        // Remove data attribute to show connect card and disclaimer
        document.documentElement.removeAttribute('data-has-connection');
        
        document.getElementById('connectCard').classList.remove('hidden');
        document.getElementById('accountCard').classList.remove('connected');
        accountConnected = false;
        stopTradingTipsRotation();
        setApiKeyVisibility(false);
        resetAccountMeta();
        
        // Clear API key input
        const apiKeyInput = document.getElementById('apiKeyInput');
        if (apiKeyInput) {
          apiKeyInput.value = '';
        }
        
        // Show disclaimer when disconnected
        document.getElementById('disclaimerSection').classList.remove('hidden');
        
        // Hide action buttons
        document.getElementById('actionButtonsContainer').classList.remove('visible');
        
        // Reset account display
        document.getElementById('fullName').textContent = '-';
        document.getElementById('accountId').textContent = '-';
        document.getElementById('balance').textContent = '-';
        document.getElementById('currency').textContent = '-';
        
        // Clear MT5 accounts list
        updateMT5AccountsDisplay([]);
      }
    }

    // Parse OAuth callback from URL parameters
    function parseOAuthCallback() {
      const urlParams = new URLSearchParams(window.location.search);
      const accounts = [];
      let i = 1;
      
      while (urlParams.has(`acct${i}`) && urlParams.has(`token${i}`) && urlParams.has(`cur${i}`)) {
        accounts.push({
          account: urlParams.get(`acct${i}`),
          token: urlParams.get(`token${i}`),
          currency: urlParams.get(`cur${i}`).toUpperCase()
        });
        i++;
      }

      if (accounts.length === 0) {
        return null;
      }

      return {
        accounts: accounts,
        selectedAccount: accounts[0]
      };
    }

    // Handle OAuth callback from URL
    async function handleOAuthCallbackFromUrl() {
      const tokens = parseOAuthCallback();
      
      if (tokens) {
        // Store tokens
        try {
          localStorage.setItem(DERIV_OAUTH_TOKENS_KEY, JSON.stringify(tokens));
          console.log('OAuth tokens stored from callback');
          
          // Clean up URL (remove OAuth parameters)
          window.history.replaceState({}, '', window.location.pathname);
          
          // Connect with the token
          try {
            await connectWithOAuth(tokens.selectedAccount.token);
          } catch (error) {
            console.error('Failed to connect after OAuth:', error);
            alert('Connected but failed to load account data. Please refresh.');
          }
        } catch (error) {
          console.error('Error storing OAuth tokens:', error);
          alert('Failed to save connection. Please try again.');
        }
      }
    }

    // Check for existing connection on page load
    async function checkExistingConnection() {
      // First, check if this is an OAuth callback
      const oauthTokens = parseOAuthCallback();
      if (oauthTokens) {
        await handleOAuthCallbackFromUrl();
        return;
      }

      let connectionSucceeded = false;

      // Check for stored OAuth tokens first
      const tokens = getStoredTokens();
      if (tokens && tokens.selectedAccount) {
        try {
          await connectWithOAuth(tokens.selectedAccount.token);
          connectionSucceeded = true;
          return;
        } catch (error) {
          console.error('Failed to reconnect with OAuth:', error);
          // If reconnection fails, clear tokens
          localStorage.removeItem(DERIV_OAUTH_TOKENS_KEY);
        }
      }

      // Fallback to API key if no OAuth tokens
      if (!connectionSucceeded) {
        const storedApiKey = getStoredApiKey();
        if (storedApiKey) {
          try {
            await connectWithApiKey(storedApiKey);
            connectionSucceeded = true;
          } catch (error) {
            console.error('Failed to reconnect with API key:', error);
            // If reconnection fails, clear API key
            localStorage.removeItem(DERIV_API_KEY_KEY);
          }
        }
      }

      // If no connection succeeded, remove the data attribute to show connect card
      if (!connectionSucceeded) {
        document.documentElement.removeAttribute('data-has-connection');
      }
    }

    // Initialize on page load
    checkExistingConnection();
  </script>
</body>
</html>
