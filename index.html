<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DFirst WebBots Lab</title>
  <script>
    // Check for existing connection synchronously before page renders
    (function() {
      try {
        const oauthTokens = localStorage.getItem('@deriv_oauth_tokens');
        const apiKey = localStorage.getItem('@deriv_api_key');
        if (oauthTokens || apiKey) {
          document.documentElement.setAttribute('data-has-connection', 'true');
        }
      } catch (e) {
        // Ignore localStorage errors
      }
    })();
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: dark;
      --bg: #0f1117;
      --panel: #171b24;
      --panel-strong: #1f2531;
      --accent: #00d2ff;
      --accent-2: #ff7a18;
      --text: #f5f7ff;
      --muted: #98a2bd;
      --border: rgba(255,255,255,0.08);
      --success: #24d970;
      --danger: #ff5f6d;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top right, rgba(0, 210, 255, 0.25), transparent 40%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .grid-bg {
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size: 48px 48px;
      z-index: 0;
    }

    .page {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 32px 24px 100px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      flex: 1;
      box-sizing: border-box;
    }

    @media (max-width: 768px) {
      .page {
        padding: 20px 16px 90px;
        gap: 16px;
      }
    }

    @media (max-width: 480px) {
      .page {
        padding: 16px 12px 85px;
        gap: 12px;
      }
    }

    .card-wrapper {
      flex: 1;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: auto;
      box-sizing: border-box;
    }

    .card {
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
      background: var(--panel);
      border-radius: 24px;
      padding: 20px;
      box-shadow: 0 18px 45px rgba(4, 6, 12, 0.55);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 18px;
      min-height: auto;
      box-sizing: border-box;
    }

    @media (max-width: 768px) {
      .card {
        padding: 16px;
        border-radius: 20px;
        max-width: 100%;
      }
    }

    .account-info {
      position: absolute;
      top: 24px;
      left: 24px;
      width: auto;
      min-width: 300px;
      max-width: 420px;
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.12) 0%, rgba(31, 37, 49, 0.95) 100%);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(0, 210, 255, 0.2);
      border: 1px solid rgba(0, 210, 255, 0.15);
      display: none;
      backdrop-filter: blur(10px);
      box-sizing: border-box;
      z-index: 2;
    }

    @media (min-width: 1024px) {
      .account-info {
        max-width: min(420px, calc(100vw - 360px));
      }
    }

    @media (max-width: 1023px) {
      .account-info {
        position: relative;
        top: auto;
        left: auto;
        width: 100%;
        max-width: 100%;
        min-width: auto;
        margin-bottom: 20px;
        padding: 20px;
      }

      .account-section {
        margin-bottom: 20px;
        padding-bottom: 16px;
      }

      .account-row {
        margin-bottom: 12px;
        padding: 10px 0;
      }

      .account-label {
        font-size: 12px;
      }

      .account-value {
        font-size: 14px;
      }

      .balance-value {
        font-size: 20px;
      }
    }

    @media (max-width: 480px) {
      .account-info {
        padding: 16px;
        border-radius: 16px;
      }

      .account-section {
        margin-bottom: 16px;
        padding-bottom: 12px;
      }

      .account-row {
        margin-bottom: 10px;
        padding: 8px 0;
        flex-wrap: wrap;
        gap: 4px;
      }

      .account-label {
        font-size: 11px;
        width: 100%;
      }

      .account-value {
        font-size: 13px;
        width: 100%;
        text-align: right;
      }

      .balance-value {
        font-size: 18px;
      }
    }

    .card h2 {
      margin: 0;
      font-size: 22px;
      color: var(--text);
      font-weight: 600;
    }

    .card p {
      margin: 0;
      color: var(--muted);
      text-align: center;
      line-height: 1.5;
      font-size: 13px;
      font-weight: 500;
    }

    .card p .powered-text {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      opacity: 0.7;
    }

    .card p .deriv-brand {
      font-size: 14px;
      font-weight: 700;
      color: #ff444f;
      text-transform: lowercase;
      letter-spacing: 0.06em;
      opacity: 1;
    }

    .powered-by-trigger {
      display: inline-block;
      cursor: default;
      user-select: none;
      position: relative;
    }

    .powered-by-trigger::after {
      content: '';
      position: absolute;
      inset: -2px;
    }

    .secret-hidden {
      display: none !important;
    }

    @media (min-width: 769px) {
      .card p {
        font-size: 14px;
      }

      .card p .powered-text {
        font-size: 13px;
      }

      .card p .deriv-brand {
        font-size: 15px;
      }
    }

    .oauth-card {
      width: 100%;
      background: var(--panel-strong);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 20px;
      box-shadow: 0 12px 30px rgba(5, 6, 11, 0.5);
    }

    .oauth-card h3 {
      margin: 0 0 10px;
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
    }

    .oauth-card p {
      margin: 0 0 16px;
      text-align: left;
      color: var(--muted);
    }

    .btn {
      width: 100%;
      height: 46px;
      border-radius: 10px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      text-decoration: none;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .btn-primary {
      background: #ff444f;
      color: #ffffff;
      box-shadow: 0 10px 20px rgba(255, 68, 79, 0.35);
    }

    .btn-secondary {
      background: #0891b2;
      color: #ffffff;
      box-shadow: 0 10px 20px rgba(8, 145, 178, 0.25);
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .divider {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 12px;
      color: #94a3b8;
      font-size: 13px;
      margin: 16px 0;
    }

    .divider::before,
    .divider::after {
      content: "";
      flex: 1;
      height: 1px;
      background: #e2e8f0;
    }

    .api-link {
      font-size: 13px;
      color: var(--muted);
      opacity: 0.6;
      cursor: default;
    }

    .account-meta {
      width: 100%;
      margin-top: 18px;
      padding: 0;
      border-radius: 0;
      border: none;
      background: transparent;
      box-shadow: none;
    }

    .account-meta h4 {
      display: none;
    }

    .meta-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .meta-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.08), rgba(255, 122, 24, 0.05));
      border: 1px solid rgba(0, 210, 255, 0.15);
      border-radius: 10px;
      transition: all 0.2s ease;
    }

    .meta-item:hover {
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.12), rgba(255, 122, 24, 0.08));
      border-color: rgba(0, 210, 255, 0.25);
    }

    .meta-label {
      font-size: 12px;
      color: rgba(152, 162, 189, 0.85);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 500;
    }

    .meta-value {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .meta-item:nth-child(1) .meta-value {
      color: #00d2ff;
    }

    .meta-item:nth-child(2) .meta-value {
      color: #ff7a18;
    }

    .meta-item:nth-child(3) .meta-value {
      color: #24d970;
    }

    .meta-item:nth-child(4) .meta-value {
      color: #a855f7;
    }

    /* API Key Input Section */
    .api-key-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .api-key-input-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .api-key-label {
      font-size: 12px;
      color: rgba(152, 162, 189, 0.8);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-family: 'Inter', system-ui, sans-serif;
    }

    .api-key-input-wrapper {
      display: flex;
      gap: 8px;
    }

    .api-key-input {
      flex: 1;
      padding: 12px 16px;
      background: rgba(31, 37, 49, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      font-family: 'Inter', system-ui, sans-serif;
      transition: all 0.2s ease;
    }

    .api-key-input:focus {
      outline: none;
      border-color: rgba(0, 210, 255, 0.5);
      background: rgba(31, 37, 49, 0.8);
      box-shadow: 0 0 0 3px rgba(0, 210, 255, 0.1);
    }

    .api-key-input::placeholder {
      color: rgba(152, 162, 189, 0.5);
    }

    .api-key-connect-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.2) 0%, rgba(0, 210, 255, 0.1) 100%);
      border: 1px solid rgba(0, 210, 255, 0.3);
      border-radius: 8px;
      color: #00d2ff;
      font-size: 14px;
      font-weight: 600;
      font-family: 'Inter', system-ui, sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .api-key-connect-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.3) 0%, rgba(0, 210, 255, 0.2) 100%);
      border-color: rgba(0, 210, 255, 0.5);
      box-shadow: 0 4px 12px rgba(0, 210, 255, 0.2);
      transform: translateY(-1px);
    }

    .api-key-connect-btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .api-key-connect-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .api-key-error {
      margin-top: 8px;
      padding: 8px 12px;
      background: rgba(255, 68, 79, 0.1);
      border: 1px solid rgba(255, 68, 79, 0.3);
      border-radius: 6px;
      color: #ff444f;
      font-size: 12px;
      font-family: 'Inter', system-ui, sans-serif;
      display: none;
    }

    .api-key-error.show {
      display: block;
    }

    @media (max-width: 768px) {
      .api-key-section {
        margin-top: 16px;
        padding-top: 16px;
      }

      .api-key-input-wrapper {
        flex-direction: column;
      }

      .api-key-connect-btn {
        width: 100%;
      }
    }

    .powered-by {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--muted);
    }

    .powered-by span:last-child {
      font-size: 18px;
      font-weight: 700;
      color: #ff444f;
      text-transform: lowercase;
      letter-spacing: 0.06em;
    }

    .account-info.connected {
      display: block;
    }

    .account-info h3 {
      margin: 0 0 24px;
      font-size: 22px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.02em;
      font-family: 'Inter', system-ui, sans-serif;
    }

    .account-section {
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .account-section:last-of-type {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .account-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding: 12px 0;
    }

    .account-row:last-child {
      margin-bottom: 0;
    }

    .account-label {
      color: rgba(152, 162, 189, 0.8);
      font-size: 13px;
      font-weight: 500;
      letter-spacing: 0.01em;
      text-transform: uppercase;
      font-family: 'Inter', system-ui, sans-serif;
    }

    .account-value {
      color: var(--text);
      font-size: 15px;
      font-weight: 600;
      letter-spacing: -0.01em;
      font-family: 'Inter', system-ui, sans-serif;
    }

    .balance-value {
      color: var(--success);
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.02em;
      font-family: 'Inter', system-ui, sans-serif;
    }

    .mt5-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .mt5-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .mt5-header h4 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.01em;
      font-family: 'Inter', system-ui, sans-serif;
    }

    .disconnect-btn {
      width: 100%;
      background: rgba(255, 95, 109, 0.15);
      color: var(--danger);
      border: 1px solid rgba(255, 95, 109, 0.3);
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', system-ui, sans-serif;
    }

    .disconnect-btn:hover {
      background: rgba(255, 95, 109, 0.25);
      border-color: rgba(255, 95, 109, 0.5);
      transform: translateY(-1px);
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid #ffffff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px 24px;
      background: rgba(15, 17, 23, 0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      z-index: 10;
      box-sizing: border-box;
    }

    @media (max-width: 768px) {
      footer {
        padding: 12px 16px;
      }
    }

    @media (max-width: 480px) {
      footer {
        padding: 10px 12px;
      }
    }

    .footer-content {
      display: flex;
      align-items: center;
      gap: 24px;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
    }

    .footer-text {
      font-size: 13px;
      color: rgba(152, 162, 189, 0.8);
      font-family: 'Inter', system-ui, sans-serif;
    }

    .powered-by {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: rgba(152, 162, 189, 0.8);
      font-family: 'Inter', system-ui, sans-serif;
    }

    .powered-by span:last-child {
      font-size: 15px;
      font-weight: 700;
      color: #ff444f;
      text-transform: lowercase;
      letter-spacing: 0.06em;
    }

    .tips-banner {
      width: 100%;
      max-width: 420px;
      margin: 0 auto 16px;
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.12), rgba(255, 122, 24, 0.08));
      border: 1px solid rgba(0, 210, 255, 0.18);
      border-radius: 14px;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.25);
      min-height: 48px;
      max-height: 48px;
      overflow: hidden;
      box-sizing: border-box;
      flex-shrink: 0;
    }

    @media (max-width: 768px) {
      .tips-banner {
        max-width: 100%;
        padding: 10px 14px;
        min-height: 44px;
        max-height: 44px;
        margin-bottom: 12px;
      }
    }

    .tips-banner .tips-label {
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.75);
      font-weight: 600;
      flex-shrink: 0;
      white-space: nowrap;
    }

    .tips-banner .tip-text {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.06em;
      color: #f8fafc;
      text-transform: uppercase;
      flex: 1;
      text-align: right;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.3;
      min-width: 0;
    }

    @media (max-width: 768px) {
      #accountMeta {
        display: none !important;
      }

      .card-wrapper {
        min-height: auto;
      }

      .trading-tips-panel {
        display: none !important;
      }

      .page {
        padding: 8px 12px;
        padding-bottom: 60px;
        gap: 12px;
      }

      .card p {
        font-size: 11px;
        margin-bottom: 8px;
      }

      .card p .powered-text {
        font-size: 10px;
      }

      .card p .deriv-brand {
        font-size: 12px;
      }

      .account-info {
        position: relative;
        top: 0;
        left: 0;
        width: 100%;
        min-width: auto;
        max-width: 100%;
        margin-bottom: 12px;
        padding: 16px;
        border-radius: 16px;
      }

      .account-info h3 {
        margin: 0 0 12px;
        font-size: 18px;
      }

      .account-section {
        margin-bottom: 12px;
        padding-bottom: 12px;
      }

      .account-row {
        margin-bottom: 8px;
        padding: 6px 0;
      }

      .account-label {
        font-size: 11px;
      }

      .account-value {
        font-size: 13px;
      }

      .balance-value {
        font-size: 18px;
      }

      .mt5-section {
        margin-top: 12px;
        padding-top: 12px;
      }

      .mt5-header {
        margin-bottom: 8px;
      }

      .mt5-header h4 {
        font-size: 15px;
      }

      .disconnect-btn {
        padding: 10px;
        font-size: 12px;
        margin-top: 12px !important;
      }

      .api-link {
        display: none;
      }

      .card {
        max-width: 100%;
        padding: 16px;
        gap: 12px;
      }

      .action-buttons-container {
        margin-bottom: 12px;
        margin-top: 0;
      }

      .action-buttons {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .action-btn.trading-btn {
        grid-column: 1 / -1;
      }

      .action-btn {
        padding: 10px 12px;
        min-height: 42px;
        height: 42px;
      }

      .action-btn .btn-label {
        font-size: 13px;
      }

      footer {
        padding: 8px 12px;
      }

      .footer-content {
        flex-direction: column;
        gap: 6px;
        text-align: center;
      }

      .footer-text {
        font-size: 10px;
      }
    }

    @media (max-width: 480px) {
      .page {
        padding: 10px 10px;
        padding-bottom: 55px;
        gap: 10px;
      }

      .account-info {
        padding: 14px;
        margin-bottom: 10px;
      }

      .account-info h3 {
        font-size: 16px;
        margin-bottom: 10px;
      }

      .account-section {
        margin-bottom: 10px;
        padding-bottom: 10px;
      }

      .account-row {
        margin-bottom: 6px;
        padding: 5px 0;
      }

      .balance-value {
        font-size: 16px;
      }

      .account-value {
        font-size: 12px;
      }

      .mt5-section {
        margin-top: 10px;
        padding-top: 10px;
      }

      .mt5-header h4 {
        font-size: 14px;
      }

      .disconnect-btn {
        padding: 8px;
        font-size: 11px;
        margin-top: 10px !important;
      }

      .action-buttons-container {
        margin-bottom: 10px;
      }

      .action-buttons {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .action-btn.trading-btn {
        grid-column: 1 / -1;
      }

      .action-btn {
        padding: 8px 10px;
        min-height: 40px;
        height: 40px;
      }

      .action-btn .btn-label {
        font-size: 12px;
      }

      footer {
        padding: 6px 10px;
      }

      .footer-content {
        gap: 4px;
      }

      .footer-text,
      .powered-by {
        font-size: 9px;
      }

      .powered-by span:last-child {
        font-size: 11px;
      }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
      .page {
        padding-bottom: 95px;
      }
    }

    .hidden {
      display: none;
    }

    /* Prevent flash on page load - hide connect card and disclaimer if connection exists */
    html[data-has-connection="true"] #connectCard {
      display: none;
    }

    html[data-has-connection="true"] #disclaimerSection {
      display: none;
    }

    /* Disclaimer Section */
    .disclaimer-section {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px 16px;
      margin-top: auto;
      margin-bottom: 0;
      transition: opacity 0.3s ease;
    }

    .disclaimer-section.hidden {
      display: none;
    }

    .disclaimer {
      background: rgba(31, 37, 49, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .disclaimer-title {
      font-size: 11px;
      font-weight: 700;
      color: #ff444f;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
      font-family: 'Inter', system-ui, sans-serif;
    }

    .disclaimer p {
      margin: 0;
      font-size: 11px;
      line-height: 1.5;
      color: rgba(152, 162, 189, 0.9);
      font-family: 'Inter', system-ui, sans-serif;
    }

    @media (max-width: 768px) {
      .disclaimer-section {
        padding: 0 12px;
        margin-bottom: 12px;
      }

      .disclaimer {
        padding: 12px 16px;
      }

      .disclaimer-title {
        font-size: 10px;
        margin-bottom: 6px;
      }

      .disclaimer p {
        font-size: 10px;
        line-height: 1.4;
      }
    }

    @media (max-width: 480px) {
      .disclaimer-section {
        padding: 0 10px;
        margin-bottom: 10px;
      }

      .disclaimer {
        padding: 10px 14px;
      }

      .disclaimer-title {
        font-size: 9px;
        margin-bottom: 5px;
      }

      .disclaimer p {
        font-size: 9px;
        line-height: 1.35;
      }
    }

    /* Action Buttons Container */
    .action-buttons-container {
      display: none;
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
    }

    .action-buttons-container.visible {
      display: block;
    }

    .action-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 16px;
      width: 100%;
    }

    .action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 14px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid;
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--panel);
      color: var(--text);
      text-decoration: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      min-height: auto;
      height: auto;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .action-btn .btn-label {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .deposit-btn {
      background: linear-gradient(135deg, rgba(36, 217, 112, 0.15) 0%, rgba(36, 217, 112, 0.08) 100%);
      border-color: rgba(36, 217, 112, 0.3);
      color: #24d970;
    }

    .deposit-btn:hover {
      background: linear-gradient(135deg, rgba(36, 217, 112, 0.25) 0%, rgba(36, 217, 112, 0.15) 100%);
      border-color: rgba(36, 217, 112, 0.5);
      box-shadow: 0 6px 20px rgba(36, 217, 112, 0.2);
    }

    .withdraw-btn {
      background: linear-gradient(135deg, rgba(255, 122, 24, 0.15) 0%, rgba(255, 122, 24, 0.08) 100%);
      border-color: rgba(255, 122, 24, 0.3);
      color: #ff7a18;
    }

    .withdraw-btn:hover {
      background: linear-gradient(135deg, rgba(255, 122, 24, 0.25) 0%, rgba(255, 122, 24, 0.15) 100%);
      border-color: rgba(255, 122, 24, 0.5);
      box-shadow: 0 6px 20px rgba(255, 122, 24, 0.2);
    }

    .trading-btn {
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.15) 0%, rgba(0, 210, 255, 0.08) 100%);
      border-color: rgba(0, 210, 255, 0.3);
      color: #00d2ff;
    }

    .trading-btn:hover {
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.25) 0%, rgba(0, 210, 255, 0.15) 100%);
      border-color: rgba(0, 210, 255, 0.5);
      box-shadow: 0 6px 20px rgba(0, 210, 255, 0.2);
    }

    /* Desktop: Move action buttons to right column */
    @media (min-width: 1024px) {
      .action-buttons-container {
        position: fixed;
        top: 50%;
        right: 24px;
        transform: translateY(-50%);
        z-index: 3;
        width: 280px;
        max-width: calc(100vw - 520px);
        margin: 0;
        box-sizing: border-box;
      }

      .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .action-btn {
        width: 100%;
        padding: 18px 20px;
        min-height: 68px;
        align-items: center;
        text-align: center;
        justify-content: center;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
        border-radius: 18px;
        box-sizing: border-box;
      }

      .action-btn .btn-label {
        font-size: 14px;
        letter-spacing: 0.05em;
        text-align: center;
      }
    }

    @media (min-width: 1200px) {
      .action-buttons-container {
        right: 32px;
        width: 300px;
      }
    }

    @media (min-width: 1400px) {
      .action-buttons-container {
        right: 40px;
        width: 320px;
      }
    }

    @media (max-width: 1023px) {
      .action-buttons-container {
        position: relative;
        margin-top: 20px;
        margin-bottom: 20px;
      }
    }

    /* Mobile: Top position */
    @media (max-width: 768px) {
      .action-buttons-container {
        position: relative;
        margin-bottom: 20px;
        margin-top: 0;
      }

      .action-buttons {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .action-btn.trading-btn {
        grid-column: 1 / -1;
      }

      .action-btn {
        padding: 12px 14px;
        min-height: 48px;
        flex-direction: row;
        justify-content: center;
      }

      .action-btn .btn-label {
        font-size: 14px;
      }

      /* When account is connected, show buttons at top */
      .page:has(.account-info.connected) .action-buttons-container {
        margin-top: 0;
      }
    }
  </style>
</head>
<body>
  <div class="grid-bg"></div>
  <main class="page">
    <div class="tips-banner secret-hidden" id="tipsBanner">
      <span class="tips-label">Market Tip</span>
      <span class="tip-text" id="tipText">Risk one percent per trade</span>
    </div>

    <div class="card-wrapper" id="cardWrapper">
    <div class="card">
      <p class="powered-line">
        <span class="powered-text">Automated Trading Platform</span>
        <span class="powered-text">-</span>
        <span class="powered-text">Powered <span id="secretByTrigger" class="powered-by-trigger">by</span></span>
        <span class="deriv-brand">deriv</span>
      </p>

      <!-- OAuth Connect Card (shown when not connected) -->
      <div class="oauth-card" id="connectCard">
        <h3>Connect with Deriv</h3>
        <p>Sign in with your Deriv account to start trading</p>
        <button class="btn btn-primary" id="connectBtn" onclick="handleOAuthLogin()">
          Connect Account
        </button>
        <div class="divider">Don't have an account yet?</div>
        <a class="btn btn-secondary" href="https://track.deriv.com/_30qaRjl291dMjdsyM5hasGNd7ZgqdRLk/1/" target="_blank" rel="noopener">
          Create Deriv Account
        </a>
      </div>
      
      <!-- API Key Input Section -->
      <div class="api-key-section secret-hidden" id="apiKeySection">
        <div class="api-key-label">Use API Key Instead</div>
        <div class="api-key-input-group">
          <div class="api-key-input-wrapper">
            <input 
              type="text" 
              id="apiKeyInput" 
              class="api-key-input" 
              placeholder="Paste your Deriv API key here"
              autocomplete="off"
            />
            <button 
              id="apiKeyConnectBtn" 
              class="api-key-connect-btn"
              onclick="handleApiKeyConnect()"
            >
              Connect
            </button>
          </div>
          <div class="api-key-error" id="apiKeyError"></div>
          <div style="margin-top: 8px;">
            <a href="https://app.deriv.com/account/api-token?t=_30qaRjl291dMjdsyM5hasGNd7ZgqdRLk" target="_blank" rel="noopener" style="font-size: 12px; color: rgba(0, 210, 255, 0.8); text-decoration: none; font-family: 'Inter', system-ui, sans-serif;">
              Don't have an API key? Create one here →
            </a>
          </div>
        </div>
      </div>

      <!-- Account Info Card (shown when connected) -->
      <div class="account-info" id="accountCard">
        <h3>Deriv Trading Account</h3>
        
        <div class="account-section">
          <div class="account-row">
            <span class="account-label">Full Name</span>
            <span class="account-value" id="fullName">-</span>
          </div>
          
          <div class="account-row">
            <span class="account-label">Account ID</span>
            <span class="account-value" id="accountId">-</span>
          </div>
          
          <div class="account-row">
            <span class="account-label">Available Balance</span>
            <span class="balance-value" id="balance">-</span>
          </div>
          
          <div class="account-row">
            <span class="account-label">Currency</span>
            <span class="account-value" id="currency">-</span>
          </div>
        </div>

        <!-- MT5 Account Section -->
        <div class="mt5-section">
          <div class="mt5-header">
            <h4>MT5 Account</h4>
            <button id="createMt5Btn" class="btn btn-secondary" style="display: none; width: auto; padding: 8px 16px; height: auto; font-size: 13px;" onclick="createMT5Account()">
              Create MT5 Account
            </button>
          </div>
          
          <div class="account-row">
            <span class="account-label">MT5 Login</span>
            <span class="account-value" id="mt5Login">-</span>
          </div>
          
          <div class="account-row">
            <span class="account-label">MT5 Balance</span>
            <span class="balance-value" id="mt5Balance">-</span>
          </div>
          
          <div class="account-row">
            <span class="account-label">MT5 Currency</span>
            <span class="account-value" id="mt5Currency">-</span>
          </div>
        </div>
        
        <button class="disconnect-btn" onclick="handleDisconnect()" style="margin-top: 24px;">Disconnect</button>
      </div>

      <span class="api-link secret-hidden" id="apiKeyFooterText">Use API Key Instead</span>

      <div class="account-meta secret-hidden" id="accountMeta">
        <div class="meta-list">
          <div class="meta-item">
            <span class="meta-label">Country</span>
            <span class="meta-value" id="countryValue">-</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Currency</span>
            <span class="meta-value" id="currencyValue">-</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Account Status</span>
            <span class="meta-value" id="accountStatusValue">-</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Landing Company</span>
            <span class="meta-value" id="landingCompanyValue">-</span>
          </div>
        </div>
      </div>
    </div>
    </div>

    <!-- Action Buttons Container (shown when connected) -->
    <div class="action-buttons-container" id="actionButtonsContainer">
      <div class="action-buttons">
        <a href="https://app.deriv.com/cashier/deposit?t=_30qaRjl291dMjdsyM5hasGNd7ZgqdRLk" target="_blank" rel="noopener" class="action-btn deposit-btn">
          <span class="btn-label">Deposit</span>
        </a>
        <a href="https://app.deriv.com/cashier/withdraw?t=_30qaRjl291dMjdsyM5hasGNd7ZgqdRLk" target="_blank" rel="noopener" class="action-btn withdraw-btn">
          <span class="btn-label">Withdraw</span>
        </a>
        <a href="trading-bots.html" class="action-btn trading-btn">
          <span class="btn-label">Start Trading</span>
        </a>
      </div>
    </div>

    <!-- Disclaimer Section (hidden when connected) -->
    <div class="disclaimer-section" id="disclaimerSection">
      <div class="disclaimer">
        <div class="disclaimer-title">DISCLAIMER</div>
        <p>Deriv offers complex derivatives, such as options and contracts for difference ("CFDs"). These products may not be suitable for all clients, and trading them puts you at risk. Please make sure that you understand the following risks before trading Deriv products: a) you may lose some or all of the money you invest in the trade, b) if your trade involves currency conversion, exchange rates will affect your profit and loss. You should never trade with borrowed money or with money that you cannot afford to lose.</p>
      </div>
    </div>

    <footer>
      <div class="footer-content">
        <div class="footer-text">© <span id="year"></span> DFirst Automation Lab</div>
      </div>
    </footer>
  </main>

  <script>
    const APP_ID = '67709';
    const DERIV_WS_URL = `wss://ws.binaryws.com/websockets/v3?app_id=${APP_ID}`;
    const DERIV_OAUTH_TOKENS_KEY = '@deriv_oauth_tokens';
    const DERIV_API_KEY_KEY = '@deriv_api_key';

    const CREATE_MT5_URL = 'https://app.deriv.com/mt5?t=_30qaRjl291dMjdsyM5hasGNd7ZgqdRLk';
    const CREATE_API_KEY_URL = 'https://app.deriv.com/account/api-token?t=_30qaRjl291dMjdsyM5hasGNd7ZgqdRLk';
    const DEPOSIT_URL = 'https://app.deriv.com/cashier/deposit?t=_30qaRjl291dMjdsyM5hasGNd7ZgqdRLk';
    const WITHDRAW_URL = 'https://app.deriv.com/cashier/withdraw?t=_30qaRjl291dMjdsyM5hasGNd7ZgqdRLk';
    const TRADING_BOTS_URL = 'https://app.deriv.com/bot?t=_30qaRjl291dMjdsyM5hasGNd7ZgqdRLk';

    const apiKeySectionEl = document.getElementById('apiKeySection');
    const apiKeyFooterText = document.getElementById('apiKeyFooterText');
    const secretByTrigger = document.getElementById('secretByTrigger');
    const tradingTipsPanel = document.getElementById('tipsBanner');
    const tipTextEl = document.getElementById('tipText');
    const cardWrapper = document.getElementById('cardWrapper');
    const accountMetaSection = document.getElementById('accountMeta');
    const countryValueEl = document.getElementById('countryValue');
    const currencyValueEl = document.getElementById('currencyValue');
    const accountStatusValueEl = document.getElementById('accountStatusValue');
    const landingCompanyValueEl = document.getElementById('landingCompanyValue');
    const metaDesktopMedia = window.matchMedia('(min-width: 769px)');
    const tipsMediaQuery = window.matchMedia('(max-width: 768px)');

    const SECRET_CLICK_THRESHOLD = 3;
    const SECRET_CLICK_WINDOW = 1200;
    let secretClickCount = 0;
    let secretClickTimer = null;
    let tradingTipInterval = null;
    let accountConnected = false;
    let tradingTipIndex = 0;

    const tradingTips = [
      'Liquidity peaks London New York',
      'Risk one percent per trade',
      'Spreads widen during news releases',
      'Synthetic indices trade nonstop',
      'Cut losses fast let winners run',
      'Protect capital before seeking profits',
      'Most traders lose to emotions not markets',
      'Volatility creates opportunity and risk',
      'Trends persist longer than expected',
      'Reversal signals need confirmation',
      'Position size determines risk exposure',
      'Market closes affect price gaps',
      'Support resistance levels guide entries',
      'Overtrading erodes account balance',
      'Patience beats impulsive decisions',
      'Stop losses protect against disasters',
      'Take profit targets prevent greed',
      'Market sentiment drives short moves',
      'News events spike volatility fast',
      'Demo practice builds real skills',
      'Consistency beats occasional wins',
      'Avoiding small losses prevents big ones'
    ];

    function renderTradingTip() {
      if (!tradingTips.length || !tipTextEl) return;
      const tip = tradingTips[tradingTipIndex % tradingTips.length];
      tipTextEl.textContent = tip;
    }

    function startTradingTipsRotation() {
      if (!tradingTipsPanel || tradingTips.length === 0 || tipsMediaQuery.matches) {
        stopTradingTipsRotation();
        return;
      }
      tradingTipsPanel.classList.remove('secret-hidden');
      renderTradingTip();
      if (tradingTipInterval) {
        clearInterval(tradingTipInterval);
      }
      tradingTipInterval = setInterval(() => {
        tradingTipIndex = (tradingTipIndex + 1) % tradingTips.length;
        renderTradingTip();
      }, 7000);
    }

    function stopTradingTipsRotation() {
      if (tradingTipInterval) {
        clearInterval(tradingTipInterval);
        tradingTipInterval = null;
      }
      tradingTipsPanel?.classList.add('secret-hidden');
    }

    function updateTradingTipsState() {
      const shouldShowTips = accountConnected && !tipsMediaQuery.matches;
      if (shouldShowTips) {
        startTradingTipsRotation();
      } else {
        stopTradingTipsRotation();
      }
    }

    function deriveAccountType(loginId, landingCompany) {
      if (landingCompany) return landingCompany;
      if (!loginId) return '-';
      if (/VRTC/i.test(loginId)) return 'Synthetic Demo';
      if (/CR/i.test(loginId)) return 'CR Account';
      if (/MF/i.test(loginId)) return 'Financial';
      return 'Deriv Account';
    }

    function updateAccountMetaVisibility(visible) {
      if (!accountMetaSection) return;
      const shouldShow = visible && metaDesktopMedia.matches;
      accountMetaSection.classList.toggle('secret-hidden', !shouldShow);
    }

    function updateAccountMetaDetails(details) {
      if (!accountMetaSection) return;
      if (countryValueEl) countryValueEl.textContent = (details.country || '-').toUpperCase();
      if (currencyValueEl) currencyValueEl.textContent = (details.currency || '-').toUpperCase();
      if (accountStatusValueEl) {
        const isVirtual = details.is_virtual === true || details.is_virtual === 1;
        accountStatusValueEl.textContent = isVirtual ? 'Demo' : 'Real';
      }
      if (landingCompanyValueEl) {
        landingCompanyValueEl.textContent = details.landingCompany || '-';
      }
      updateAccountMetaVisibility(accountConnected);
    }

    function resetAccountMeta() {
      if (countryValueEl) countryValueEl.textContent = '-';
      if (currencyValueEl) currencyValueEl.textContent = '-';
      if (accountStatusValueEl) accountStatusValueEl.textContent = '-';
      if (landingCompanyValueEl) landingCompanyValueEl.textContent = '-';
      updateAccountMetaVisibility(false);
    }

    function setApiKeyVisibility(visible) {
      if (!apiKeySectionEl) return;
      apiKeySectionEl.classList.toggle('secret-hidden', !visible);
      if (apiKeyFooterText) {
        apiKeyFooterText.classList.toggle('secret-hidden', !visible);
      }
      updateTradingTipsState();
    }

    setApiKeyVisibility(false);

    if (typeof tipsMediaQuery.addEventListener === 'function') {
      tipsMediaQuery.addEventListener('change', updateTradingTipsState);
    } else if (typeof tipsMediaQuery.addListener === 'function') {
      tipsMediaQuery.addListener(updateTradingTipsState);
    }

    if (typeof metaDesktopMedia.addEventListener === 'function') {
      metaDesktopMedia.addEventListener('change', () => updateAccountMetaVisibility(accountConnected));
    } else if (typeof metaDesktopMedia.addListener === 'function') {
      metaDesktopMedia.addListener(() => updateAccountMetaVisibility(accountConnected));
    }

    secretByTrigger?.addEventListener('click', () => {
      secretClickCount += 1;
      if (secretClickTimer) {
        clearTimeout(secretClickTimer);
      }
      secretClickTimer = setTimeout(() => {
        secretClickCount = 0;
      }, SECRET_CLICK_WINDOW);

      if (secretClickCount >= SECRET_CLICK_THRESHOLD) {
        secretClickCount = 0;
        const shouldShow = apiKeySectionEl?.classList.contains('secret-hidden');
        setApiKeyVisibility(shouldShow);
      }
    });

    // Get OAuth URL with proper redirect
    function getOAuthUrl() {
      // Use the dashboard URL itself as redirect (Deriv will append OAuth params)
      const redirectUri = encodeURIComponent(window.location.origin + window.location.pathname);
      return `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&l=en&brand=deriv&app_markup_percentage=0&t=_30qaRjl291dMjdsyM5hasGNd7ZgqdRLk&redirect_uri=${redirectUri}`;
    }

    // Create MT5 Account with partner link
    function createMT5Account() {
      window.open(CREATE_MT5_URL, '_blank');
    }

    // Handle OAuth login
    function handleOAuthLogin() {
      const btn = document.getElementById('connectBtn');
      btn.disabled = true;
      btn.innerHTML = 'Connecting<span class="loading"></span>';
      
      const oauthUrl = getOAuthUrl();
      window.location.href = oauthUrl;
    }

    // Get stored OAuth tokens
    function getStoredTokens() {
      try {
        const stored = localStorage.getItem(DERIV_OAUTH_TOKENS_KEY);
        return stored ? JSON.parse(stored) : null;
      } catch (error) {
        console.error('Error reading stored tokens:', error);
        return null;
      }
    }

    // Connect with API key and fetch account data (same flow as OAuth)
    function connectWithApiKey(apiKey) {
      return new Promise((resolve, reject) => {
        const ws = new WebSocket(DERIV_WS_URL);
        let authorized = false;
        let connectionTimeout;

        const cleanup = () => {
          if (connectionTimeout) clearTimeout(connectionTimeout);
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.close();
          }
        };

        connectionTimeout = setTimeout(() => {
          if (!authorized) {
            cleanup();
            reject(new Error('Connection timeout'));
          }
        }, 10000);

        ws.onopen = () => {
          console.log('WebSocket connected (API Key)');
          ws.send(JSON.stringify({
            authorize: apiKey.trim(),
            req_id: Date.now()
          }));
        };

        ws.onmessage = (msg) => {
          try {
            const response = JSON.parse(msg.data);

            if (response.error) {
              console.error('WebSocket error:', response.error);
              cleanup();
              reject(new Error(response.error.message || 'Connection failed'));
              return;
            }

            if (response.msg_type === 'authorize' && response.authorize) {
              authorized = true;
              clearTimeout(connectionTimeout);

              const landing = response.authorize.landing_company_fullname || response.authorize.landing_company_name || '-';
              const loginid = response.authorize.loginid;
              const accountData = {
                account_id: loginid,
                loginid,
                balance: Number(response.authorize.balance),
                currency: response.authorize.currency,
                fullName: response.authorize.fullname || '-',
                email: response.authorize.email || '-',
                country: response.authorize.country || '-',
                landingCompany: landing,
                account_type: response.authorize.account_type || deriveAccountType(loginid, landing),
                is_virtual: response.authorize.is_virtual === 1 || response.authorize.is_virtual === true,
                server_time: response.authorize.server_time
              };

              // Get account status for additional details
              ws.send(JSON.stringify({
                get_account_status: 1,
                req_id: Date.now()
              }));

              // Try to get MT5 account info
              ws.send(JSON.stringify({
                mt5_login_list: 1,
                req_id: Date.now()
              }));

              // Update UI with account data
              updateAccountDisplay(accountData);
            }

            if (response.msg_type === 'get_account_status' && response.get_account_status) {
              const status = response.get_account_status;
              if (status.fullname) {
                updateAccountName(status.fullname);
              }
            }

            if (response.msg_type === 'mt5_login_list') {
              if (response.mt5_login_list?.length > 0) {
                const mt5Account = response.mt5_login_list[0];
                ws.send(JSON.stringify({
                  mt5_get_settings: 1,
                  login: mt5Account.login,
                  req_id: Date.now()
                }));
              } else {
                // No MT5 account - show create button
                updateMT5Display(null);
                setTimeout(() => {
                  cleanup();
                  resolve(true);
                }, 500);
              }
            }

            if (response.msg_type === 'mt5_get_settings' && response.mt5_get_settings) {
              const mt5Settings = response.mt5_get_settings;
              updateMT5Display({
                login: mt5Settings.login,
                balance: Number(mt5Settings.balance),
                currency: mt5Settings.currency
              });
              setTimeout(() => {
                cleanup();
                resolve(true);
              }, 500);
            }
          } catch (error) {
            console.error('Error processing message:', error);
          }
        };

        ws.onerror = (error) => {
          console.error('WebSocket error:', error);
          cleanup();
          reject(new Error('Connection error'));
        };

        ws.onclose = () => {
          console.log('WebSocket closed');
        };
      });
    }

    // Connect with OAuth token and fetch account data
    function connectWithOAuth(token) {
      return new Promise((resolve, reject) => {
        const ws = new WebSocket(DERIV_WS_URL);
        let authorized = false;
        let connectionTimeout;

        const cleanup = () => {
          if (connectionTimeout) clearTimeout(connectionTimeout);
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.close();
          }
        };

        connectionTimeout = setTimeout(() => {
          if (!authorized) {
            cleanup();
            reject(new Error('Connection timeout'));
          }
        }, 10000);

        ws.onopen = () => {
          console.log('WebSocket connected');
          ws.send(JSON.stringify({
            authorize: token,
            req_id: Date.now()
          }));
        };

        ws.onmessage = (msg) => {
          try {
            const response = JSON.parse(msg.data);

            if (response.error) {
              console.error('WebSocket error:', response.error);
              cleanup();
              reject(new Error(response.error.message || 'Connection failed'));
              return;
            }

            if (response.msg_type === 'authorize' && response.authorize) {
              authorized = true;
              clearTimeout(connectionTimeout);

              const landing = response.authorize.landing_company_fullname || response.authorize.landing_company_name || '-';
              const loginid = response.authorize.loginid;
              const accountData = {
                account_id: loginid,
                loginid,
                balance: Number(response.authorize.balance),
                currency: response.authorize.currency,
                fullName: response.authorize.fullname || '-',
                email: response.authorize.email || '-',
                country: response.authorize.country || '-',
                landingCompany: landing,
                account_type: response.authorize.account_type || deriveAccountType(loginid, landing),
                is_virtual: response.authorize.is_virtual === 1 || response.authorize.is_virtual === true,
                server_time: response.authorize.server_time
              };

              // Get account status for additional details
              ws.send(JSON.stringify({
                get_account_status: 1,
                req_id: Date.now()
              }));

              // Try to get MT5 account info
              ws.send(JSON.stringify({
                mt5_login_list: 1,
                req_id: Date.now()
              }));

              // Update UI with account data
              updateAccountDisplay(accountData);
            }

            if (response.msg_type === 'get_account_status' && response.get_account_status) {
              const status = response.get_account_status;
              if (status.fullname) {
                updateAccountName(status.fullname);
              }
            }

            if (response.msg_type === 'mt5_login_list') {
              if (response.mt5_login_list?.length > 0) {
                const mt5Account = response.mt5_login_list[0];
                ws.send(JSON.stringify({
                  mt5_get_settings: 1,
                  login: mt5Account.login,
                  req_id: Date.now()
                }));
              } else {
                // No MT5 account - show create button
                updateMT5Display(null);
                setTimeout(() => {
                  cleanup();
                  resolve(true);
                }, 500);
              }
            }

            if (response.msg_type === 'mt5_get_settings' && response.mt5_get_settings) {
              const mt5Settings = response.mt5_get_settings;
              updateMT5Display({
                login: mt5Settings.login,
                balance: Number(mt5Settings.balance),
                currency: mt5Settings.currency
              });
              setTimeout(() => {
                cleanup();
                resolve(true);
              }, 500);
            }
          } catch (error) {
            console.error('Error processing message:', error);
          }
        };

        ws.onerror = (error) => {
          console.error('WebSocket error:', error);
          cleanup();
          reject(new Error('Connection error'));
        };

        ws.onclose = () => {
          console.log('WebSocket closed');
        };
      });
    }

    // Update account name
    function updateAccountName(name) {
      document.getElementById('fullName').textContent = name || '-';
    }

    // Update account display
    function updateAccountDisplay(account) {
      document.getElementById('fullName').textContent = account.fullName || '-';
      document.getElementById('accountId').textContent = account.account_id || '-';
      document.getElementById('balance').textContent = account.balance ? account.balance.toFixed(2) : '-';
      document.getElementById('currency').textContent = account.currency || '-';
      
      // Set data attribute to prevent flash on refresh
      document.documentElement.setAttribute('data-has-connection', 'true');
      
      // Show account card, hide connect card
      document.getElementById('connectCard').classList.add('hidden');
      document.getElementById('accountCard').classList.add('connected');
      
      // Hide disclaimer when connected
      document.getElementById('disclaimerSection').classList.add('hidden');
      
      // Show action buttons
      document.getElementById('actionButtonsContainer').classList.add('visible');
      accountConnected = true;
      updateTradingTipsState();
      updateAccountMetaDetails(account);
    }

    // Update MT5 display
    function updateMT5Display(mt5Account) {
      const createBtn = document.getElementById('createMt5Btn');
      
      if (mt5Account) {
        // Has MT5 account
        document.getElementById('mt5Login').textContent = mt5Account.login || '-';
        document.getElementById('mt5Balance').textContent = mt5Account.balance ? mt5Account.balance.toFixed(2) : '-';
        document.getElementById('mt5Currency').textContent = mt5Account.currency || '-';
        createBtn.style.display = 'none';
      } else {
        // No MT5 account - show create button
        document.getElementById('mt5Login').textContent = 'N/A';
        document.getElementById('mt5Balance').textContent = 'N/A';
        document.getElementById('mt5Currency').textContent = 'N/A';
        createBtn.style.display = 'inline-flex';
      }
    }

    // Get stored API key
    function getStoredApiKey() {
      try {
        return localStorage.getItem(DERIV_API_KEY_KEY);
      } catch (error) {
        console.error('Error reading stored API key:', error);
        return null;
      }
    }

    // Store API key
    function storeApiKey(apiKey) {
      try {
        localStorage.setItem(DERIV_API_KEY_KEY, apiKey);
      } catch (error) {
        console.error('Error storing API key:', error);
      }
    }

    // Handle API key connect
    async function handleApiKeyConnect() {
      const apiKeyInput = document.getElementById('apiKeyInput');
      const connectBtn = document.getElementById('apiKeyConnectBtn');
      const errorDiv = document.getElementById('apiKeyError');
      const apiKey = apiKeyInput.value.trim();

      if (!apiKey) {
        errorDiv.textContent = 'Please enter your API key';
        errorDiv.classList.add('show');
        return;
      }

      // Hide error, disable button, show loading
      errorDiv.classList.remove('show');
      connectBtn.disabled = true;
      connectBtn.textContent = 'Connecting...';

      try {
        await connectWithApiKey(apiKey);
        // Store API key on successful connection
        storeApiKey(apiKey);
        // Clear input
        apiKeyInput.value = '';
        // Clear URL params if any
        if (window.location.search) {
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      } catch (error) {
        console.error('API key connection error:', error);
        errorDiv.textContent = error.message || 'Failed to connect with API key. Please check your key and try again.';
        errorDiv.classList.add('show');
        connectBtn.disabled = false;
        connectBtn.textContent = 'Connect';
      }
    }

    // Allow Enter key to trigger connect
    document.addEventListener('DOMContentLoaded', () => {
      const apiKeyInput = document.getElementById('apiKeyInput');
      if (apiKeyInput) {
        apiKeyInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            handleApiKeyConnect();
          }
        });
      }
    });

    // Handle disconnect
    function handleDisconnect() {
      if (confirm('Are you sure you want to disconnect your Deriv account?')) {
        localStorage.removeItem(DERIV_OAUTH_TOKENS_KEY);
        localStorage.removeItem(DERIV_API_KEY_KEY);
        
        // Remove data attribute to show connect card and disclaimer
        document.documentElement.removeAttribute('data-has-connection');
        
        document.getElementById('connectCard').classList.remove('hidden');
        document.getElementById('accountCard').classList.remove('connected');
        accountConnected = false;
        stopTradingTipsRotation();
        setApiKeyVisibility(false);
        resetAccountMeta();
        
        // Clear API key input
        const apiKeyInput = document.getElementById('apiKeyInput');
        if (apiKeyInput) {
          apiKeyInput.value = '';
        }
        
        // Show disclaimer when disconnected
        document.getElementById('disclaimerSection').classList.remove('hidden');
        
        // Hide action buttons
        document.getElementById('actionButtonsContainer').classList.remove('visible');
        
        // Reset account display
        document.getElementById('fullName').textContent = '-';
        document.getElementById('accountId').textContent = '-';
        document.getElementById('balance').textContent = '-';
        document.getElementById('currency').textContent = '-';
        document.getElementById('mt5Login').textContent = '-';
        document.getElementById('mt5Balance').textContent = '-';
        document.getElementById('mt5Currency').textContent = '-';
        document.getElementById('createMt5Btn').style.display = 'none';
      }
    }

    // Parse OAuth callback from URL parameters
    function parseOAuthCallback() {
      const urlParams = new URLSearchParams(window.location.search);
      const accounts = [];
      let i = 1;
      
      while (urlParams.has(`acct${i}`) && urlParams.has(`token${i}`) && urlParams.has(`cur${i}`)) {
        accounts.push({
          account: urlParams.get(`acct${i}`),
          token: urlParams.get(`token${i}`),
          currency: urlParams.get(`cur${i}`).toUpperCase()
        });
        i++;
      }

      if (accounts.length === 0) {
        return null;
      }

      return {
        accounts: accounts,
        selectedAccount: accounts[0]
      };
    }

    // Handle OAuth callback from URL
    async function handleOAuthCallbackFromUrl() {
      const tokens = parseOAuthCallback();
      
      if (tokens) {
        // Store tokens
        try {
          localStorage.setItem(DERIV_OAUTH_TOKENS_KEY, JSON.stringify(tokens));
          console.log('OAuth tokens stored from callback');
          
          // Clean up URL (remove OAuth parameters)
          window.history.replaceState({}, '', window.location.pathname);
          
          // Connect with the token
          try {
            await connectWithOAuth(tokens.selectedAccount.token);
          } catch (error) {
            console.error('Failed to connect after OAuth:', error);
            alert('Connected but failed to load account data. Please refresh.');
          }
        } catch (error) {
          console.error('Error storing OAuth tokens:', error);
          alert('Failed to save connection. Please try again.');
        }
      }
    }

    // Check for existing connection on page load
    async function checkExistingConnection() {
      // First, check if this is an OAuth callback
      const oauthTokens = parseOAuthCallback();
      if (oauthTokens) {
        await handleOAuthCallbackFromUrl();
        return;
      }

      let connectionSucceeded = false;

      // Check for stored OAuth tokens first
      const tokens = getStoredTokens();
      if (tokens && tokens.selectedAccount) {
        try {
          await connectWithOAuth(tokens.selectedAccount.token);
          connectionSucceeded = true;
          return;
        } catch (error) {
          console.error('Failed to reconnect with OAuth:', error);
          // If reconnection fails, clear tokens
          localStorage.removeItem(DERIV_OAUTH_TOKENS_KEY);
        }
      }

      // Fallback to API key if no OAuth tokens
      if (!connectionSucceeded) {
        const storedApiKey = getStoredApiKey();
        if (storedApiKey) {
          try {
            await connectWithApiKey(storedApiKey);
            connectionSucceeded = true;
          } catch (error) {
            console.error('Failed to reconnect with API key:', error);
            // If reconnection fails, clear API key
            localStorage.removeItem(DERIV_API_KEY_KEY);
          }
        }
      }

      // If no connection succeeded, remove the data attribute to show connect card
      if (!connectionSucceeded) {
        document.documentElement.removeAttribute('data-has-connection');
      }
    }

    // Initialize on page load
    document.getElementById('year').textContent = new Date().getFullYear();
    checkExistingConnection();
  </script>
</body>
</html>
